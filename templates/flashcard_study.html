{% extends "base.html" %}

{% block title %}Bookme - Study {{ deck.name }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles-flashcards.css') }}">
    <style>
        .flashcard-page { background-color: #f9f9f9; min-height: 100vh; }
    </style>
{% endblock %}

{% block body_attrs %}class="flashcard-page text-dark"{% endblock %}

{% block content %}
    <main>
        <div class="study-page-container">
            <!-- Header Section -->
            <div class="study-header-section d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="study-title">{{ deck.name }}</h1>
                    <div class="study-subtitle">{{ deck.summary|default('No summary', true) }}</div>
                </div>

                <div class="d-flex gap-2 align-items-center">
                    <a href="{{ url_for('flashcards.index', deck_id=deck_id) }}" class="btn-study-outline">
                        <span class="material-symbols-outlined" style="font-size: 16px;">arrow_back</span>
                        BACK TO DECKS
                    </a>
                    {% if permissions and deck.id in permissions.get('editor', []) %}
                        <a href="{{ url_for('flashcards.edit', deck_id = deck_id) }}" class="btn btn-success">Edit</a>
                    {% endif %}
                </div>
            </div>

            <!-- Flashcard -->
            <div class="study-card mt-4">
                <!-- Card Top Meta -->
                <div class="card-meta-top d-flex justify-content-between">
                    <span class="card-label">CARD <span id="current-index">1</span> / <span id="total-cards">--</span></span>
                    <span class="card-label" id="card-state-label">FRONT</span>
                </div>

                <!-- Card Content -->
                <div class="card-content">
                    <div id="card-front-text" class="card-text-display">Loading...</div>

                    <div id="answer-area" class="answer-reveal d-none">
                        <div class="card-type-label">ANSWER</div>
                        <div id="card-back-text" class="answer-text"></div>
                    </div>

                    <div class="mt-5 d-flex flex-column align-items-center gap-3 w-100">
                        <button id="show-answer" class="btn-study-primary">SHOW ANSWER</button>
                        <div class="d-flex gap-3 justify-content-center w-100">
                            <button id="incorrect-btn" class="btn-study-outline d-none" style="border-color: #ef4444; color: #ef4444;">INCORRECT</button>
                            <button id="correct-btn" class="btn-study-outline d-none" style="border-color: #22c55e; color: #22c55e;">CORRECT</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="study-controls d-flex justify-content-center align-items-center gap-4 mt-4">
                <button id="btn-prev" class="nav-circle-btn"><span class="material-symbols-outlined">chevron_left</span></button>
                <div style="display: flex; gap: 8px;"></div>
                <button id="btn-next" class="nav-circle-btn"><span class="material-symbols-outlined">chevron_right</span></button>
            </div>

            <!-- Hidden inputs/data for JS -->
            <script>
                const STUDY_CARDS = [
                    {% for cid, card in deck.cards.items() %}
                        { "id": {{ cid | tojson }}, "front": {{ card.front | tojson }}, "back": {{ card.back | tojson }} }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ];

                (function () {
                    let idx = 0;
                    const totalEl = document.getElementById('total-cards');
                    const currEl = document.getElementById('current-index');
                    const frontText = document.getElementById('card-front-text');
                    const backText = document.getElementById('card-back-text');
                    const answerArea = document.getElementById('answer-area');
                    const showBtn = document.getElementById('show-answer');
                    const correctBtn = document.getElementById('correct-btn');
                    const incorrectBtn = document.getElementById('incorrect-btn');
                    const stateLabel = document.getElementById('card-state-label');
                    const btnPrev = document.getElementById('btn-prev');
                    const btnNext = document.getElementById('btn-next');

                    const deckId = `{{ deck_id }}`;
                    const reviewUrl = `{{ url_for('flashcards.flashcards_review') }}`;

                    function render() {
                        if (STUDY_CARDS.length === 0) {
                            frontText.textContent = 'No cards in this deck.';
                            showBtn.disabled = true;
                            if (totalEl) totalEl.textContent = '0';
                            if (currEl) currEl.textContent = '0';
                            return;
                        }

                        if (idx < 0) idx = STUDY_CARDS.length - 1;
                        if (idx >= STUDY_CARDS.length) idx = 0;

                        const c = STUDY_CARDS[idx];
                        if (totalEl) totalEl.textContent = STUDY_CARDS.length;
                        if (currEl) currEl.textContent = idx + 1;
                        frontText.textContent = c.front;
                        backText.textContent = c.back;

                        answerArea.classList.add('d-none');
                        showBtn.classList.remove('d-none');
                        correctBtn.classList.add('d-none');
                        incorrectBtn.classList.add('d-none');
                        showBtn.disabled = false;
                        if (stateLabel) stateLabel.textContent = 'FRONT';
                    }

                    function postReview(cardId, correct) {
                        fetch(reviewUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ deck_id: deckId, card_id: cardId, correct: correct })
                        }).then(r => r.json()).then(data => {
                            idx = (idx + 1) % STUDY_CARDS.length;
                            render();
                        }).catch(err => {
                            console.error('Review error', err);
                            idx = (idx + 1) % STUDY_CARDS.length;
                            render();
                        });
                    }

                    showBtn.addEventListener('click', function () {
                        answerArea.classList.remove('d-none');
                        showBtn.classList.add('d-none');
                        correctBtn.classList.remove('d-none');
                        incorrectBtn.classList.remove('d-none');
                        if (stateLabel) stateLabel.textContent = 'BACK';
                    });

                    correctBtn.addEventListener('click', function () { postReview(STUDY_CARDS[idx].id, true); });
                    incorrectBtn.addEventListener('click', function () { postReview(STUDY_CARDS[idx].id, false); });

                    if (btnPrev) btnPrev.addEventListener('click', function () { idx = (idx - 1 + STUDY_CARDS.length) % STUDY_CARDS.length; render(); });
                    if (btnNext) btnNext.addEventListener('click', function () { idx = (idx + 1) % STUDY_CARDS.length; render(); });

                    document.addEventListener('DOMContentLoaded', render);
                })();
            </script>
        </div>
    </main>
{% endblock %}
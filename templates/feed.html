{% extends "base.html" %}

{% block title %}Community - Feed | BookMe{% endblock %}

{% block head %}
    <style>
        /* ===================================
           PAGE-SPECIFIC: FEED
           =================================== */
        
        .community-page-content {
            background-color: #fff;
        }

        .community-title {
            font-family: var(--font-serif);
            font-style: italic;
            font-size: 4.5rem;
            color: #1c1c1c;
            margin-bottom: 0.5rem;
            line-height: 1.1;
        }

        .community-subtitle {
            color: #666;
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 4rem;
        }

        /* Custom Tabs */
        .nav-tabs-custom {
            border-bottom: 1px solid #eee;
            margin-bottom: 3rem;
            display: flex;
            gap: 2rem;
            padding-bottom: 0;
        }

        .nav-link-custom {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.8rem;
            font-weight: 600;
            color: #999;
            text-decoration: none;
            padding-bottom: 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-link-custom:hover {
            color: #1a1a1a;
        }

        .nav-link-custom.active {
            color: #1a1a1a;
            border-bottom-color: #1a1a1a;
        }

        /* Feed Specific Styles */
        .feed-card {
            background-color: #fff;
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #f0f0f0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        }

        .feed-card:hover {
            box-shadow: 0 4px 25px rgba(0,0,0,0.04);
        }

        .post-input {
            border: none;
            resize: none;
            font-size: 1rem;
            color: #1c1c1c;
            background: transparent;
            padding: 0.5rem 0;
        }
        
        .post-input:focus {
            box-shadow: none;
            outline: none;
            background: transparent;
        }

        .post-input::placeholder {
            color: #999;
            font-weight: 300;
        }

        .add-image-btn {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #666;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .add-image-btn:hover {
            color: #1a1a1a;
        }

        /* Feed Post Typography */
        .post-author-name {
            font-family: var(--font-serif);
            font-style: italic;
            font-size: 1.1rem;
            color: #1c1c1c;
            font-weight: 400;
        }

        .post-time {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #999;
            margin-top: 2px;
        }

        .post-text {
            color: #444;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            font-weight: 300;
        }

        .post-footer-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #666;
            font-size: 0.75rem;
            font-weight: 600;
            background: none;
            border: none;
            padding: 0;
            text-decoration: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .post-footer-btn:hover {
            color: #1a1a1a;
        }
        
        .post-footer-btn .material-symbols-outlined {
            font-size: 18px;
        }

        /* Post avatar */
        .post-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Images posted in posts */
        .post-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 12px;
        }

        /* Like/comment/share action buttons */
        .post-actions button {
            background: none;
            border: none;
            color: #666;
            padding: 8px 16px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .post-actions button:hover {
            color: #2badee;
        }

        /* Black pill button for post */
        .btn-black-pill {
            background-color: #1a1a1a;
            color: #fff;
            border-radius: 100px;
            padding: 12px 24px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            transition: background 0.2s;
        }

        .btn-black-pill:hover {
            background-color: #333;
            color: #fff;
        }
    </style>
{% endblock %}

{% block body_attrs %}class="community-page-content text-dark"{% endblock %}

{% block content %}
    <!-- Main Content -->
    <main class="flex-grow-1">
      <div class="container my-5">
        <!-- Page Header -->
        <div class="mb-5">
            <h1 class="community-title">Community Hub</h1>
            <p class="community-subtitle">Connect and share knowledge with fellow learners.</p>
            
            <!-- Custom Tabs -->
            <div class="nav-tabs-custom">
                <a href="{{ url_for('community.index') }}" class="nav-link-custom">Notes</a>
                <a href="{{ url_for('friends.index') }}" class="nav-link-custom">Friends</a>
                <a href="{{ url_for('feed.index') }}" class="nav-link-custom active">Feed</a>
            </div>
        </div>

        <!-- Create Post Section -->
        <div class="feed-card">
          <div class="d-flex gap-4">
             <!-- User Avatar -->
             <div class="flex-shrink-0">
                {% if profileData and profileData.profile_pic %}
                <img src="{{ profileData.profile_pic }}" class="post-avatar" alt="Your avatar" />
                {% else %}
                <img src="https://ui-avatars.com/api/?name={{ profileData.name or username }}&background=E0C9A6&color=fff&size=60"
                  class="post-avatar" alt="Your avatar" />
                {% endif %}
             </div>
             
             <!-- Content Area -->
             <div class="flex-grow-1">
                 <textarea id="postText" class="post-input form-control p-0" rows="2"
                   placeholder="Share your study progress, notes, or thoughts..."></textarea>
                 
                 <!-- Image Preview Container -->
                 <div id="imagePreview" class="mt-3 d-none">
                     <img src="" class="img-fluid rounded-3" style="max-height: 200px; object-fit: cover;">
                     <button type="button" class="btn-close position-absolute" style="margin-left: -25px; margin-top: 5px;" onclick="clearImage()"></button>
                 </div>

                 <div class="d-flex justify-content-between align-items-center mt-4 border-top pt-3">
                     <div>
                         <input type="file" id="postImage" class="d-none" accept="image/*" onchange="previewImage(this)">
                         <button class="add-image-btn" onclick="document.getElementById('postImage').click()">
                             <span class="material-symbols-outlined fs-5">image</span>
                             Add Image
                         </button>
                     </div>
                     <button class="btn-black-pill" onclick="createPost()">
                         POST
                     </button>
                 </div>
             </div>
          </div>
        </div>

        <!-- Feed Posts -->
        <div id="feedContainer">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="d-md-none d-sm-12" style="height:10vh"></div>
    </main>

    <!-- Mobile Footer -->
    <footer class="d-md-none fixed-bottom bg-white border-top">
      <nav class="nav justify-content-around py-2">
        <a class="nav-link d-flex flex-column align-items-center text-muted" href="{{ url_for('home.index') }}"><span
            class="material-symbols-outlined fs-4">home</span>
          <small class="d-block">Home</small></a>
        <a class="nav-link d-flex flex-column align-items-center text-muted" href="{{ url_for('study.index') }}"><span
            class="material-symbols-outlined fs-4">school</span>
          <small class="d-block">Study</small></a>
        <a class="nav-link d-flex flex-column align-items-center text-muted"
          href="{{ url_for('community.index') }}"><span class="material-symbols-outlined fs-4">groups</span>
          <small class="d-block">Community</small></a>
      </nav>
    </footer>

  <!-- Comment Modal -->
  <div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Comments</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="commentList" class="mb-3"></div>
        </div>
        <div class="modal-footer">
          <input type="text" id="commentInput" class="form-control me-2" placeholder="Write a comment..." />
          <button class="btn btn-primary" onclick="submitComment()">
            Send
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    let activePostId = null;

    // Format timestamp
    function formatPostTime(timestamp) {
      if (!timestamp) return "Just now";
      const postDate = new Date(timestamp);
      const now = new Date();
      const diffMs = now - postDate;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return "Just now";
      if (diffMin < 60)
        return `${diffMin} minute${diffMin === 1 ? "" : "s"} ago`;
      if (diffHour < 24)
        return `${diffHour} hour${diffHour === 1 ? "" : "s"} ago`;
      if (diffDay < 7) return `${diffDay} day${diffDay === 1 ? "" : "s"} ago`;
      return postDate.toLocaleDateString();
    }

    // Convert file to Data URL
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Image Preview Helper
    function previewImage(input) {
        const previewDiv = document.getElementById('imagePreview');
        const img = previewDiv.querySelector('img');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
                previewDiv.classList.remove('d-none');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function clearImage() {
        const input = document.getElementById('postImage');
        const previewDiv = document.getElementById('imagePreview');
        input.value = '';
        previewDiv.classList.add('d-none');
    }

    // Create Post
    async function createPost() {
      const textInput = document.getElementById("postText");
      const imageInput = document.getElementById("postImage");
      const text = (textInput?.value || "").trim();

      if (
        !text &&
        !(imageInput && imageInput.files && imageInput.files.length)
      ) {
        alert("Please write something or add an image");
        return;
      }

      let image = null;
      if (imageInput && imageInput.files && imageInput.files[0]) {
        try {
          image = await readFileAsDataURL(imageInput.files[0]);
        } catch (e) {
          console.error("Error reading image:", e);
        }
      }

      try {
        const response = await fetch("/feed/api/feed/posts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, image }),
        });

        if (response.ok) {
          textInput.value = "";
          imageInput.value = "";
          renderFeed();
        } else {
          alert("Failed to create post. Please try again.");
        }
      } catch (e) {
        alert("Network error. Please try again.");
      }
    }

    // Like Post
    async function likePost(postId) {
      try {
        await fetch(`/feed/api/feed/posts/${postId}/like`, {
          method: "POST",
        });
        loadFeed();
      } catch (e) {
        console.error("Error liking post:", e);
      }
    }

    // Open Comments
    async function openComments(postId) {
      activePostId = postId;
      try {
        const res = await fetch(`/feed/api/feed/posts/${postId}`);
        if (!res.ok) throw new Error("Failed to load comments");

        const post = await res.json();
        const list = document.getElementById("commentList");
        list.innerHTML = "";

        const comments = post.comments || [];
        if (!comments.length) {
          list.innerHTML =
            '<div class="text-muted text-center py-3">No comments yet. Be the first to comment!</div>';
        } else {
          comments.forEach((c) => {
            const div = document.createElement("div");
            div.className = "border rounded p-3 mb-2";
            div.innerHTML = `
                            <div class="d-flex align-items-start gap-2">
                                <img src="https://i.pravatar.cc/40?u=${c.author
              }" class="rounded-circle" width="40" height="40" alt="${c.author
              }">
                                <div class="flex-grow-1">
                                    <strong>${c.author}</strong>
                                    <p class="mb-1">${c.text}</p>
                                    <small class="text-muted">${new Date(
                c.timestamp
              ).toLocaleString()}</small>
                                </div>
                            </div>
                        `;
            list.appendChild(div);
          });
        }

        const modalEl = document.getElementById("commentModal");
        let modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (!modalInstance) modalInstance = new bootstrap.Modal(modalEl);
        if (!modalEl.classList.contains("show")) modalInstance.show();
      } catch (e) {
        alert("Failed to load comments.");
      }
    }

    // Submit Comment
    async function submitComment() {
      if (!activePostId) return;

      const inputEl = document.getElementById("commentInput");
      const text = (inputEl?.value || "").trim();

      if (!text) {
        alert("Please write a comment");
        return;
      }

      try {
        const res = await fetch(
          `/feed/api/feed/posts/${activePostId}/comments`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          }
        );

        if (res.ok) {
          inputEl.value = "";
          openComments(activePostId);
          loadFeed();
        } else {
          alert("Failed to submit comment. Please try again.");
        }
      } catch (e) {
        alert("Network error. Please try again.");
      }
    }

    // Load Feed
    async function loadFeed() {
      const container = document.getElementById("feedContainer");

      try {
        const res = await fetch("/feed/api/feed/posts");
        const posts = await res.json();

        if (!posts || posts.length === 0) {
          container.innerHTML = `
                        <div class="card p-5 text-center">
                            <span class="material-symbols-outlined" style="font-size: 64px; color: #ccc;">feed</span>
                            <h5 class="mt-3">No posts yet</h5>
                            <p class="text-muted">Be the first to share something!</p>
                        </div>
                    `;
          return;
        }

        container.innerHTML = "";
        posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "card p-4 mb-4";

          card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center gap-3">
                                ${post.author_profile_pic
              ? `<img src="${post.author_profile_pic}" class="post-avatar" alt="${post.author}">`
              : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(
                post.author
              )}&background=0D6EFD&color=fff&size=60" class="post-avatar" alt="${post.author
              }">`
            }
                                <div>
                                    <h6 class="mb-0 fw-bold">${post.author}</h6>
                                    <small class="text-muted">${formatPostTime(
              post.timestamp
            )}</small>
                                </div>
                            </div>
                        </div>
                        ${post.text ? `<p class="mb-2">${post.text}</p>` : ""}
                        ${post.image
              ? `<img src="${post.image}" class="post-image" alt="Post image">`
              : ""
            }
                        <hr class="my-3">
                        <div class="d-flex justify-content-between post-actions">
                            <button onclick="likePost('${post._id}')">
                                <span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">thumb_up</span>
                                ${post.likes || 0}
                            </button>
                            <button onclick="openComments('${post._id}')">
                                <span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">comment</span>
                                ${(post.comments || []).length}
                            </button>
                            <button>
                                <span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">share</span>
                                Share
                            </button>
                        </div>
                    `;

          container.appendChild(card);
        });
      } catch (e) {
        container.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading feed</strong><br>
                        Please refresh the page or try again later.
                    </div>
                `;
      }
    }

    // New Render Feed Logic (Community Hub Design)
    async function renderFeed() {
      const container = document.getElementById("feedContainer");

      try {
        const res = await fetch("/feed/api/feed/posts");
        const posts = await res.json();

        if (!posts || posts.length === 0) {
          container.innerHTML = `
                        <div class="card p-5 text-center">
                            <span class="material-symbols-outlined" style="font-size: 64px; color: #ccc;">feed</span>
                            <h5 class="mt-3">No posts yet</h5>
                            <p class="text-muted">Be the first to share something!</p>
                        </div>
                    `;
          return;
        }

        container.innerHTML = "";
        posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "feed-card";

          const authorName = post.author || "Unknown";
          const avatarUrl = post.author_profile_pic 
              ? post.author_profile_pic 
              : `https://ui-avatars.com/api/?name=${encodeURIComponent(authorName)}&background=random&color=fff&size=60`;

          card.innerHTML = `
              <!-- Post Header -->
              <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="d-flex align-items-center gap-3">
                      <img src="${avatarUrl}" class="post-avatar" alt="${authorName}">
                      <div>
                          <div class="post-author-name">${authorName}</div>
                          <div class="post-time">${formatPostTime(post.timestamp)}</div>
                      </div>
                  </div>
                  <button class="btn btn-link text-muted p-0">
                      <span class="material-symbols-outlined">more_horiz</span>
                  </button>
              </div>

              <!-- Post Content -->
              <div class="mb-4">
                  <p class="post-text">${post.text}</p>
                  ${post.image ? `<img src="${post.image}" class="img-fluid rounded-4 w-100 mt-2" alt="Post custom image">` : ''}
              </div>

              <!-- Post Footer -->
              <div class="d-flex justify-content-between align-items-center border-top pt-3">
                  <div class="d-flex gap-4">
                      <span class="d-flex align-items-center gap-2" style="cursor: pointer" onclick="likePost('${post._id}')">
                           <span class="material-symbols-outlined ${post.is_liked ? 'text-danger' : ''}">favorite</span>
                           ${post.likes || 0}
                      </span>
                      
                      <span class="d-flex align-items-center gap-2" style="cursor: pointer" onclick="openComments('${post._id}')">
                           <span class="material-symbols-outlined">chat_bubble</span>
                           ${post.comments ? post.comments.length : 0}
                      </span>
                  </div>
                  
                  <button class="post-footer-btn">
                      <span class="material-symbols-outlined">share</span>
                      SHARE
                  </button>
              </div>
          `;
          container.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        container.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading feed</strong><br>
                        Please refresh the page or try again later.
                    </div>
                `;
      }
    }

    // Load feed on page load
    document.addEventListener("DOMContentLoaded", renderFeed);
  </script>
{% endblock %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Focus Tracker | BookMe</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <link href="{{ url_for('static', filename='styles-responsive.css') }}" rel="stylesheet">
  <style>
    body { background-color: #f6f7f8; color: #111; min-height: 100vh; padding: 0; margin: 0; }
    .timer-content { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 30px; }
    .timer-container { background: #fff; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 6px 16px rgba(0,0,0,0.1); max-width:450px; width:100%; text-align:center; margin-bottom:2rem; }
    .timer-display { font-size: 3rem; font-weight: 800; color: #2badee; margin: 1.5rem 0; }
    .control-btn { font-size:1.1rem; margin:0.3rem; border-radius:10px; padding:0.6rem 1.2rem; }
    .progress { height:8px; margin:20px 0; border-radius:10px; }
    .stats-container { background:#fff; padding:1.5rem; border-radius:1rem; box-shadow:0 6px 16px rgba(0,0,0,0.1); max-width:450px; width:100%; }
  </style>
</head>

<body>

    <!-- Header -->
    <header class="w-100 bg-white border-bottom site-header">
      <div class="container d-flex align-items-center justify-content-between py-3">
        <a class="col-1 d-flex align-items-center justify-content-center py-3 text-decoration-none" href="{{ url_for('home.index') }}">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Bookme Logo" class="header-logo-static">
        </a>
        <nav class="d-none d-md-flex align-items-center gap-2">
          <a class="btn btn-sm btn-light rounded-pill" href="{{ url_for('home.index') }}">Home</a>
          <a class="btn btn-sm btn-light rounded-pill" href="{{ url_for('study.index') }}">Study</a>
          <a class="btn btn-sm btn-light rounded-pill" href="{{ url_for('community.index') }}">Community</a>
          <a class="btn btn-sm btn-light rounded-pill" href="{{ url_for('challenges.index') }}">Challenge</a>
        </nav>
        <div class="d-none d-md-flex align-items-center gap-3">
          <div class="dropdown">
            <button type="button" class="btn btn-link text-muted p-0" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Notifications">
              <span class="material-symbols-outlined">notifications</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end p-3" style="width: 300px;">
              <li class="text-center text-muted small py-3">No new notifications. <br>Can't start procrastinating now!</li>
            </ul>
          </div>
          <div class="dropdown">
            <a class="btn btn-link text-muted p-0" href="#" id="profileDropdown" data-bs-toggle="dropdown">
              <span class="material-symbols-outlined fs-3">account_circle</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><h6 class="dropdown-header">Account</h6></li>
              <li><a class="dropdown-item" href="{{ url_for('profile.index') }}">Profile & Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><form method="POST" action="{{ url_for('auth.logout') }}" class="m-0"><button type="submit" class="dropdown-item">Log out</button></form></li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <div class="timer-content">
      <div class="timer-container">
        <h2 class="fw-bold mb-3">‚è± Study Timer</h2>

        <div class="input-group mb-3">
          <input type="text" id="timer-input" class="form-control text-center timer-display" placeholder="Enter minutes..." aria-label="Timer input">
        </div>
        <div class="progress">
          <div class="progress-bar bg-primary" id="progress-bar" style="width: 0%;"></div>
        </div>

        <div>
          <button class="btn btn-primary control-btn" id="start">Start</button>
          <button class="btn btn-warning control-btn" id="pause">Pause</button>
          <button class="btn btn-secondary control-btn" id="reset">Reset</button>
        </div>
      </div>

      <div class="stats-container">
        <h4 class="fw-bold mb-3">üìä Your Progress</h4>
        <p><strong>Daily Study Time:</strong> <span id="daily-time">0</span> minutes</p>
        <p><strong>Current Streak:</strong> <span id="streak">0</span> days</p>

        <h5 class="fw-bold mt-4 mb-2">üèÜ Leaderboard (local)</h5>
        <ol id="leaderboard"></ol>
      </div>
    </div>

    <!-- Mobile Footer -->
    <footer class="d-md-none fixed-bottom bg-white border-top">
      <nav class="nav justify-content-around py-2">
        <a class="nav-link text-muted" href="{{ url_for('home.index') }}">
          <span class="material-symbols-outlined">home</span>
          <small class="d-block">Home</small>
        </a>
        <a class="nav-link text-muted" href="{{ url_for('study.index') }}">
          <span class="material-symbols-outlined">school</span>
          <small class="d-block">Study</small>
        </a>
        <a class="nav-link text-muted" href="{{ url_for('community.index') }}">
          <span class="material-symbols-outlined">groups</span>
          <small class="d-block">Community</small>
        </a>
        <a class="nav-link text-muted" href="{{ url_for('challenges.index') }}">
          <span class="material-symbols-outlined">emoji_events</span>
          <small class="d-block">Challenge</small>
        </a>
      </nav>
    </footer>

    <script>
      // TIMER LOGIC
      let timer = null;
      let running = false;
      let timeLeft = 0;
      let duration = 0;
      let totalSeconds = 0;

      const display = document.getElementById("timer-input");
      const progressBar = document.getElementById("progress-bar");

      display.style.fontVariantNumeric = 'tabular-nums';

      function formatMMSS(seconds) {
        const mm = Math.floor(seconds / 60).toString().padStart(2, '0');
        const ss = (seconds % 60).toString().padStart(2, '0');
        return `${mm}:${ss}`;
      }

      function updateProgressBar() {
        if (running && duration > 0) {
          const progress = (1 - timeLeft / duration) * 100;
          progressBar.style.width = `${progress}%`;
        } else {
          progressBar.style.width = `0%`;
        }
      }

      function parseTimeInput(value) {
        if (!value || value.trim() === '') return 0;
        const trimmed = value.trim();
        if (trimmed.includes(':')) {
          const [mm, ss] = trimmed.split(':').map(n => parseInt(n) || 0);
          return Math.max(0, mm * 60 + ss);
        }
        const minutes = parseFloat(trimmed);
        return isNaN(minutes) ? 0 : Math.max(0, Math.round(minutes * 60));
      }

      function startTimer() {
        if (running) return;
        const secs = parseTimeInput(display.value);
        if (secs <= 0) {
          alert('Enter a valid time before starting!');
          return;
        }
        duration = secs;
        timeLeft = secs;
        totalSeconds = 0;
        running = true;
        display.readOnly = true;
        updateProgressBar();
        timer = setInterval(() => {
          if (timeLeft > 0) {
            timeLeft--;
            totalSeconds++;
            display.value = formatMMSS(timeLeft);
            updateProgressBar();
          } else {
            clearInterval(timer);
            running = false;
            const minutesStudied = Math.round(totalSeconds / 60);
            saveStudyTime(minutesStudied);
            saveSessionToMongoDB(minutesStudied);
            display.readOnly = false;
            alert('Session complete! Great work!');
          }
        }, 1000);
      }

      function pauseTimer() {
        clearInterval(timer);
        running = false;
      }

      function resetTimer() {
        clearInterval(timer);
        running = false;
        timeLeft = 0;
        duration = 0;
        totalSeconds = 0;
        display.value = '';
        display.readOnly = false;
        progressBar.style.width = '0%';
      }

      // Event listeners
      document.getElementById("start").addEventListener("click", startTimer);
      document.getElementById("pause").addEventListener("click", pauseTimer);
      document.getElementById("reset").addEventListener("click", resetTimer);

      display.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          startTimer();
        }
      });

      // ===== SEND TO MONGODB =====
      async function saveSessionToMongoDB(durationMinutes) {
        try {
          const response = await fetch('/timer/api/study/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ duration: durationMinutes, mode: "custom", subject: "general" })
          });
          const data = await response.json();
          console.log("MongoDB Save:", data.message);
        } catch (err) {
          console.error("MongoDB Error:", err);
        }
      }

      // ===== LOCAL STATS LOGIC =====
      function saveStudyTime(minutes) {
        const today = new Date().toLocaleDateString();
        let data = JSON.parse(localStorage.getItem("studyData")) || {};
        data[today] = (data[today] || 0) + minutes;
        localStorage.setItem("studyData", JSON.stringify(data));
        updateStats();
      }

      function updateStats() {
        const data = JSON.parse(localStorage.getItem("studyData")) || {};
        const today = new Date().toLocaleDateString();
        const dailyMinutes = data[today] || 0;
        document.getElementById("daily-time").textContent = dailyMinutes;

        // Calculate streak
        let streak = 0;
        const sortedDays = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));
        let currentDate = new Date();
        for (let i = sortedDays.length - 1; i >= 0; i--) {
          const day = new Date(sortedDays[i]);
          if (data[sortedDays[i]] >= 40 && day.toDateString() === currentDate.toDateString()) {
            streak++;
            currentDate.setDate(currentDate.getDate() - 1);
          } else {
            break;
          }
        }
        document.getElementById("streak").textContent = streak;
        localStorage.setItem("streak", streak);
        updateLeaderboard();
      }

      function updateLeaderboard() {
        const data = JSON.parse(localStorage.getItem("studyData")) || {};
        const leaderboard = Object.entries(data)
          .map(([date, minutes]) => ({ date, minutes }))
          .sort((a, b) => b.minutes - a.minutes)
          .slice(0, 5);
        const list = document.getElementById("leaderboard");
        list.innerHTML = leaderboard.map(entry =>
          `<li>${entry.date} ‚Äî <strong>${entry.minutes} mins</strong></li>`
        ).join("");
      }

      // Initialize
      updateStats();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>

  </html>
   <!-- function pauseTimer() {
      clearInterval(timer);
      running = false;
    }

    function resetTimer() {
      clearInterval(timer);
      running = false;
      // If timer was started before, reset to the initial start duration; otherwise reset to the currently set digits time
      if (initialDuration > 0) {
        timeLeft = initialDuration;
        duration = initialDuration;
      } else {
        // If there are digits typed use them, otherwise try parsing the display
        if (setSeconds > 0) {
          duration = setSeconds;
          timeLeft = setSeconds;
        } else {
          const secs = parseInputToSeconds(display.value);
          duration = secs;
          timeLeft = secs;
        }
      }
      totalSeconds = 0;
      // When reset to a known time show it
      if (timeLeft > 0) display.value = formatMMSS(timeLeft);
      else updateFromDigits();
      progressBar.style.width = `0%`;
    }

    // Key handling for the display: digits append on the right, max 4 characters
    display.addEventListener('keydown', (e) => {
      // allow Enter to start, Escape to clear, Backspace to remove rightmost digit
      if (e.key >= '0' && e.key <= '9') {
        e.preventDefault();
        digits = (digits + e.key).slice(-4);
        updateFromDigits();
        return;
      }

      if (e.key === 'Backspace') {
        e.preventDefault();
        digits = digits.slice(0, -1);
        updateFromDigits();
        return;
      }

      if (e.key === 'Enter') {
        e.preventDefault();
        startTimer();
        return;
      }

      if (e.key === 'Escape') {
        e.preventDefault();
        digits = '';
        setSeconds = 0;
        updateFromDigits();
        return;
      }

      // Prevent other editing keys
      e.preventDefault();
    });

    // Support paste of mm:ss or numeric text
    display.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text') || '';
      const onlyDigits = text.replace(/\D/g, '');
      if (onlyDigits.length > 0) {
        // keep last 4 digits from pasted content
        digits = onlyDigits.slice(-4);
        updateFromDigits();
      } else if (text.includes(':')) {
        // fallback to mm:ss parse
        const secs = parseInputToSeconds(text);
        if (secs > 0) {
          const mm = Math.floor(secs / 60).toString().padStart(2, '0');
          const ss = (secs % 60).toString().padStart(2, '0');
          display.value = `${mm}:${ss}`;
          setSeconds = secs;
          digits = '';
        }
      }
    });

    display.addEventListener('focus', () => {
      // keep focusable but avoid text caret issues
      display.blur();
      // small timeout to refocus so key events work consistently on mobile/desktop
      setTimeout(() => { display.focus(); }, 10);
    });

    document.getElementById("start").addEventListener("click", startTimer);
    document.getElementById("pause").addEventListener("click", pauseTimer);
    document.getElementById("reset").addEventListener("click", resetTimer);

    // ===== SEND TO MONGODB =====
    async function saveSessionToMongoDB(durationMinutes) {
      try {
        const response = await fetch('/timer/api/study/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            duration: durationMinutes,
            mode: "custom",
            subject: "general"
          })
        });
        const data = await response.json();
        console.log("MongoDB Save:", data.message);
      } catch (err) {
        console.error("MongoDB Error:", err);
      }
    }

    // ===== LOCAL STATS LOGIC =====
    function saveStudyTime(minutes) {
      const today = new Date().toLocaleDateString();
      let data = JSON.parse(localStorage.getItem("studyData")) || {};

      if (!data[today]) data[today] = 0;
      data[today] += minutes;

      localStorage.setItem("studyData", JSON.stringify(data));
      updateStats();
    }

    function updateStats() {
      const data = JSON.parse(localStorage.getItem("studyData")) || {};
      const today = new Date().toLocaleDateString();
      const dailyMinutes = data[today] || 0;
      document.getElementById("daily-time").textContent = dailyMinutes;

      let streak = 0;
      const days = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));
      let current = new Date();

      for (let i = days.length - 1; i >= 0; i--) {
        const day = new Date(days[i]);
        if (data[days[i]] >= 40 && day.toDateString() === current.toDateString()) {
          streak++;
          current.setDate(current.getDate() - 1);
        }
      }

      document.getElementById("streak").textContent = streak;
      localStorage.setItem("streak", streak);

      updateLeaderboard();
    }

    function updateLeaderboard() {
      const data = JSON.parse(localStorage.getItem("studyData")) || {};
      const leaderboard = Object.entries(data)
        .map(([date, minutes]) => ({ date, minutes }))
        .sort((a, b) => b.minutes - a.minutes)
        .slice(0, 5);

      const list = document.getElementById("leaderboard");
      list.innerHTML = leaderboard
        .map(entry => `<li>${entry.date} ‚Äî <strong>${entry.minutes} mins</strong></li>`) 
        .join("");
    }

    // initialize display
    updateStats();
    updateFromDigits();
  </script>  -->

  <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>-->
</body>

</html>
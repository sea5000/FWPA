{% extends "base.html" %}

{% block title %}Bookme - Edit {{ deck.name }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles-flashcards.css') }}">
    <style>
        .flashcard-page {
            background-color: #f9f9f9;
            min-height: 100vh;
        }
    </style>
{% endblock %}

{% block body_attrs %}class="flashcard-page text-dark"{% endblock %}

{% block content %}
<main>
    <div class="study-page-container">
        
        <form method="POST" id="edit-deck-form">
            <!-- Header Section -->
            <div class="study-header-section align-items-center mb-5">
                <div style="flex: 1;">
                    <div class="study-subtitle mb-2">EDITING DECK</div>
                    <!-- Title Input -->
                    <input type="text" class="edit-title-input" name="deck_name" 
                           value="{{ deck.name }}" placeholder="Deck Name">
                    <!-- Summary Input -->
                    <textarea class="edit-summary-input auto-expand" name="deck_summary" 
                              rows="1" placeholder="Add a brief summary...">{{ deck.summary }}</textarea>
                </div>
                
                <!-- Header Actions -->
                <div class="d-flex gap-2 ms-4">
                    <a href="{{ url_for('flashcards.index', deck_id = deck_id) }}" class="btn-study-outline">
                        <span class="material-symbols-outlined" style="font-size: 18px;">arrow_back</span>
                        BACK
                    </a>
                    
                    <button type="button" id="shareBtn" class="btn-study-outline">
                        <span class="material-symbols-outlined" style="font-size: 18px;">share</span>
                        SHARE
                    </button>
                    
                    <button type="button" id="deleteBtn" class="btn-study-danger">
                        <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                        DELETE
                    </button>
                </div>
            </div>

            <!-- Cards List -->
            <div class="deck-cards-list">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="study-subtitle">CARDS IN DECK</div>
                    <button type="button" id="add-new-card" class="btn-study-outline" style="font-size: 0.65rem; padding: 0.5rem 1rem;">
                        <span class="material-symbols-outlined" style="font-size: 16px;">add</span>
                        ADD CARD
                    </button>
                </div>

                <!-- Existing Cards -->
                {% for cardn, card in deck.cards.items() %}
                <div class="edit-card-item position-relative" id="card-row-{{cardn}}">
                    <!-- Deleted Overlay -->
                    <div class="card-deleted-overlay position-absolute top-0 start-0 w-100 h-100 d-none flex-column align-items-center justify-content-center" 
                         style="background: rgba(255,255,255,0.95); z-index: 10; border-radius: 20px; backdrop-filter: blur(2px);">
                        <div class="text-danger fw-bold mb-3" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em;">MARKED FOR DELETION</div>
                        <button type="button" class="btn-study-outline card-undo-btn" data-target="{{cardn}}" style="border-color: #6b7280; color: #6b7280;">
                            <span class="material-symbols-outlined" style="font-size: 16px;">undo</span>
                            UNDO
                        </button>
                    </div>

                    <div class="d-flex gap-4 align-items-start">
                        <div class="flex-grow-1">
                            <label class="edit-card-label">FRONT</label>
                            <textarea class="edit-card-textarea auto-expand" name="front_{{cardn}}" rows="1">{{ card.front }}</textarea>
                        </div>
                        <div class="flex-grow-1">
                            <label class="edit-card-label">BACK</label>
                            <textarea class="edit-card-textarea auto-expand" name="back_{{cardn}}" rows="1">{{ card.back }}</textarea>
                        </div>
                        
                        <!-- Delete Action (Flex Item) -->
                        <div class="pt-4 mt-1"> <!-- Padding top to align with textareas -->
                            <input class="form-check-input d-none card-delete-checkbox" type="checkbox" name="delete_{{cardn}}" id="delete_{{cardn}}">
                            <button type="button" class="btn btn-link text-danger p-0 border-0 card-delete-trigger" data-target="{{cardn}}" title="Delete Card"
                                    style="opacity: 0.6; transition: all 0.2s ease; text-decoration: none;">
                                <span class="material-symbols-outlined" style="font-size: 24px;">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- New Cards Container -->
                <div id="new-cards-container"></div>
                
                <!-- Hidden Template for New Cards -->
                <div class="d-none" id="new-card-template">
                    <div class="edit-card-item new-card-row position-relative">
                        <button type="button" class="btn-close position-absolute remove-new-card" aria-label="Remove" style="top: 1rem; right: 1rem; background-size: 0.8rem;"></button>
                        <div class="d-flex gap-4">
                            <div class="flex-grow-1">
                                <label class="edit-card-label">FRONT</label>
                                <textarea class="edit-card-textarea auto-expand" name="new_front[]" rows="1" placeholder="Front text"></textarea>
                            </div>
                            <div class="flex-grow-1">
                                <label class="edit-card-label">BACK</label>
                                <textarea class="edit-card-textarea auto-expand" name="new_back[]" rows="1" placeholder="Back text"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div style="height: 100px;"></div> <!-- Spacer for fixed footer -->

            <!-- Save Bar (Floating Bottom) -->
            <div class="save-bar">
                <span class="material-symbols-outlined text-white">save</span>
                <button type="submit">SAVE CHANGES</button>
            </div>
            
            <input type="hidden" name="deck_id" value="{{deck.id}}" />
        </form>

    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="z-index:3000;background:rgba(0,0,0,0.45);">
        <div class="d-flex align-items-center justify-content-center h-100 p-3">
            <div class="bg-white rounded shadow-sm p-4" style="max-width:480px; width:100%; border-radius: 24px;">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="m-0" style="font-family: 'Playfair Display', serif;">Confirm Deletion</h5>
                    <button type="button" class="btn-close" id="closeDeleteModal" aria-label="Close"></button>
                </div>
                <p class="mb-4 text-muted">Are you sure you want to delete this deck? This action cannot be undone.</p>
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn-study-outline" id="cancelDelete" style="border: none;">CANCEL</button>
                    <form method="POST" action="{{ url_for('flashcards.delete', deck_id = deck_id) }}" class="m-0">
                        <button type="submit" class="btn-study-danger">DELETE DECK</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share/Chat/Floater Placeholders (Preserved functionality) -->
    <!-- Floating chat button -->
    <button id="floating-chat-button" class="btn btn-primary d-inline-flex align-items-center justify-content-center"
        aria-label="Open chat" title="Chat">
        <span class="material-symbols-outlined" style="font-size:22px;">chat</span>
    </button>
    <!-- Chat panel -->
    <div id="floating-chat-panel" role="dialog" aria-hidden="true" aria-label="Chat window" style="display:none;">
        <div id="floating-chat-header">
            <div>
                <div class="chat-title">AI Assistant</div>
                <div class="chat-sub">Flashcard Maker</div>
            </div>
            <button id="floating-chat-close" type="button" class="btn btn-sm btn-light" aria-label="Close" title="Close"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div id="floating-chat-body">
            <div class="text-muted small">Type request...</div>
        </div>
        <div id="floating-chat-footer">
             <div id="file-drop" class="file-drop" title="Drop file"><span class="material-symbols-outlined">attach_file</span><input id="file-drop-input" type="file" style="display:none" /></div>
            <input id="chat-message-input" class="form-control form-control-sm chat-input" type="text" placeholder="Write a message..." />
            <button id="chat-send-btn" class="btn btn-primary send-btn" type="button"><span class="material-symbols-outlined">send</span></button>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; border: none;">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title" style="font-family: 'Playfair Display', serif;">Share Deck</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input id="share-search" class="form-control mb-3" placeholder="Search friends..." style="border-radius: 12px;">
                    <table class="table table-sm table-borderless">
                        <tbody id="share-list"></tbody>
                    </table>
                    <div id="share-empty" class="text-center text-muted small d-none">No friends found.</div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" id="share-save" class="btn-study-primary">Save Permissions</button>
                </div>
            </div>
        </div>
    </div>

</main>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='flashcards.js') }}"></script>

    <script>
        // Auto-expand textarea
        document.addEventListener('input', function (e) {
            if (e.target.classList.contains('auto-expand')) {
                e.target.style.height = 'auto';
                e.target.style.height = (e.target.scrollHeight) + 'px';
            }
        });
        
        // Add New Card Logic
        document.getElementById('add-new-card').addEventListener('click', function() {
            const container = document.getElementById('new-cards-container');
            const template = document.getElementById('new-card-template').firstElementChild.cloneNode(true);
            container.appendChild(template);
            
            // Focus first input
            const input = template.querySelector('textarea');
            if(input) input.focus();
            
            // Remove button logic
            template.querySelector('.remove-new-card').addEventListener('click', function() {
               template.remove(); 
            });
        });

        // Chat & Share Logic
        document.addEventListener('DOMContentLoaded', function() {
             console.log("Chat script initializing...");
             
             const openBtn = document.getElementById('floating-chat-button');
             const panel = document.getElementById('floating-chat-panel');
             const closeBtn = document.getElementById('floating-chat-close');
             
             // Chat Elements
             const chatBody = document.getElementById('floating-chat-body');
             const chatInput = document.getElementById('chat-message-input');
             const sendBtn = document.getElementById('chat-send-btn');
             const fileInput = document.getElementById('file-drop-input');
             const fileDrop = document.getElementById('file-drop');

             if(openBtn && panel) {
                 openBtn.addEventListener('click', (e) => {
                     e.preventDefault();
                     console.log("Chat button clicked");
                     panel.classList.add('show');
                     panel.style.display = 'flex'; // Force display
                     setTimeout(() => {
                        const input = document.getElementById('chat-message-input');
                        if(input) input.focus();
                     }, 100);
                 });
                 
                 closeBtn.addEventListener('click', (e) => {
                     e.preventDefault();
                     panel.classList.remove('show');
                     panel.style.display = 'none';
                 });
             } else {
                 console.error("Chat elements not found", {openBtn, panel});
             }
             
             // File handling
             let currentFile = null;
             if(fileDrop && fileInput) {
                 fileDrop.addEventListener('click', () => fileInput.click());
                 fileInput.addEventListener('change', () => {
                     if(fileInput.files.length > 0) {
                         currentFile = fileInput.files[0];
                         fileDrop.innerHTML = '<span class="material-symbols-outlined text-success">check_circle</span>';
                         fileDrop.title = currentFile.name;
                     }
                 });
             }

             // Send Message Logic
             async function sendMessage() {
                 const text = chatInput.value.trim();
                 if (!text && !currentFile) return;

                 // Add User Message to Chat
                 appendMessage('user', text + (currentFile ? ` [File: ${currentFile.name}]` : ''));
                 chatInput.value = '';
                 
                 // Show Loading
                 const loadingId = appendMessage('system', 'Thinking...');
                 
                 const formData = new FormData();
                 formData.append('message', text);
                 if (currentFile) {
                     formData.append('file', currentFile);
                 }

                 try {
                     const response = await fetch('/api/chat-proxy/', {
                         method: 'POST',
                         body: formData
                     });
                     
                     const data = await response.json();
                     
                     // Remove Loading
                     document.getElementById(loadingId)?.remove();

                     if (data.status === 'success' && data.json) {
                         const payload = data.json;
                         appendMessage('ai', data.feedback || "Here are your flashcards.");
                         
                         // Add Flashcards to UI
                         if (payload.flashcards && Array.isArray(payload.flashcards)) {
                             const container = document.getElementById('new-cards-container');
                             payload.flashcards.forEach(card => {
                                 const template = document.getElementById('new-card-template').firstElementChild.cloneNode(true);
                                 template.querySelector('textarea[name="new_front[]"]').value = card.front;
                                 template.querySelector('textarea[name="new_back[]"]').value = card.back;
                                 container.appendChild(template);
                                 
                                 // Attach remove listener to new card
                                 template.querySelector('.remove-new-card').addEventListener('click', function() {
                                    template.remove(); 
                                 });
                             });
                             
                             // Auto-scroll to bottom of page to see new cards
                             window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                         }
                         
                         // Clear file
                         currentFile = null;
                         fileInput.value = '';
                         fileDrop.innerHTML = '<span class="material-symbols-outlined">attach_file</span>';

                     } else {
                         appendMessage('system', 'Error: ' + (data.message || 'Unknown error'));
                     }
                 } catch (err) {
                     document.getElementById(loadingId)?.remove();
                     appendMessage('system', 'Network Error: ' + err.message);
                 }
             }
             
             function appendMessage(role, text) {
                 const div = document.createElement('div');
                 div.className = 'chat-msg ' + role;
                 div.style.marginBottom = '8px';
                 div.style.padding = '8px';
                 div.style.borderRadius = '8px';
                 div.style.fontSize = '0.85rem';
                 
                 if(role === 'user') {
                     div.style.background = '#e3f2fd';
                     div.style.alignSelf = 'flex-end';
                     div.style.marginLeft = '20%';
                 } else {
                     div.style.background = '#f5f5f5';
                     div.style.marginRight = '20%';
                 }
                 
                 div.textContent = text;
                 div.id = 'msg-' + Date.now();
                 chatBody.appendChild(div);
                 chatBody.scrollTop = chatBody.scrollHeight;
                 
                 return div.id;
             }

             if(sendBtn) {
                 sendBtn.addEventListener('click', sendMessage);
             }
             if(chatInput) {
                 chatInput.addEventListener('keypress', (e) => {
                     if(e.key === 'Enter') sendMessage();
                 });
             }
             
             // Share Modal Logic
             const shareBtn = document.getElementById('shareBtn');
             const shareList = document.getElementById('share-list');
             const shareSearch = document.getElementById('share-search');
             const shareSave = document.getElementById('share-save');
             
             // Friends data injected from backend
             const FRIENDS = [
                {% for friend in friends %}
                { username: "{{ friend.username }}", id: "{{ friend.id }}" }, 
                {% endfor %}
             ];
             
             // We'll track local state of permissions
             let shareState = {}; 
             // Note: ideally we fetch existing permissions here
             // For now we start empty or default
             
             function renderShareList(filterText = '') {
                 shareList.innerHTML = '';
                 const filtered = FRIENDS.filter(f => f.username.toLowerCase().includes(filterText.toLowerCase()));
                 
                 if(filtered.length === 0) {
                     document.getElementById('share-empty').classList.remove('d-none');
                 } else {
                     document.getElementById('share-empty').classList.add('d-none');
                 }
                 
                 filtered.forEach(friend => {
                     const u = friend.username;
                     const isEditor = shareState[u]?.editor || false;
                     const isReviewer = shareState[u]?.reviewer || false;
                     
                     const tr = document.createElement('tr');
                     tr.innerHTML = `
                        <td class="align-middle fw-bold">${u}</td>
                        <td class="text-center">
                            <input class="form-check-input" type="checkbox" ${isEditor ? 'checked' : ''} 
                                onchange="updateShare('${u}', 'editor', this.checked)">
                        </td>
                        <td class="text-center">
                            <input class="form-check-input" type="checkbox" ${isReviewer ? 'checked' : ''} 
                                onchange="updateShare('${u}', 'reviewer', this.checked)">
                        </td>
                     `;
                     shareList.appendChild(tr);
                 });
             }
             
             // Global for inline handlers
             window.updateShare = function(username, role, val) {
                 if(!shareState[username]) shareState[username] = { editor: false, reviewer: false };
                 shareState[username][role] = val;
             };

             if(shareBtn) {
                 shareBtn.addEventListener('click', () => {
                     const modal = new bootstrap.Modal(document.getElementById('shareModal'));
                     modal.show();
                     renderShareList();
                 });
             }
             
             if(shareSearch) {
                 shareSearch.addEventListener('input', (e) => renderShareList(e.target.value));
             }
             
             if(shareSave) {
                 shareSave.addEventListener('click', () => {
                     const deckId = "{{ deck_id }}";
                     // Transform state to array
                     const shares = Object.keys(shareState).map(u => ({
                         username: u,
                         editor: shareState[u].editor,
                         reviewer: shareState[u].reviewer
                     }));
                     
                     fetch(`/flashcards/${deckId}/share`, {
                         method: 'POST',
                         headers: {'Content-Type': 'application/json'},
                         body: JSON.stringify({ shares: shares })
                     }).then(r => r.json())
                     .then(d => {
                         if(d.ok) {
                             // Close modal
                             const el = document.getElementById('shareModal');
                             const modal = bootstrap.Modal.getInstance(el);
                             modal.hide();
                             alert('Permissions updated!');
                         } else {
                             alert('Error updating permissions');
                         }
                     });
                 });
             }

             
             // Card Delete Interactions
             // Use delegation for dynamic/static elements
             document.addEventListener('click', function(e) {
                 // Open Delete Overlay
                 if(e.target.closest('.card-delete-trigger')) {
                     const btn = e.target.closest('.card-delete-trigger');
                     const cardN = btn.dataset.target;
                     const row = document.getElementById(`card-row-${cardN}`);
                     const checkbox = row.querySelector('.card-delete-checkbox');
                     const overlay = row.querySelector('.card-deleted-overlay');
                     
                     checkbox.checked = true;
                     overlay.classList.remove('d-none');
                     overlay.classList.add('d-flex');
                 }
                 
                 // Undo Delete
                 if(e.target.closest('.card-undo-btn')) {
                     const btn = e.target.closest('.card-undo-btn');
                     const cardN = btn.dataset.target;
                     const row = document.getElementById(`card-row-${cardN}`);
                     const checkbox = row.querySelector('.card-delete-checkbox');
                     const overlay = row.querySelector('.card-deleted-overlay');
                     
                     checkbox.checked = false;
                     overlay.classList.add('d-none');
                     overlay.classList.remove('d-flex');
                 }
             });
        });
    </script>
{% endblock %}

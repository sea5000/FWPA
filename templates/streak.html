{% extends "base.html" %}

{% block title %}Bookme - Streak{% endblock %}

{% block head %}
    <!-- Streak-specific styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles-streak.css') }}" />
{% endblock %}

{% block body_attrs %}class="bg-light text-dark"{% endblock %}

{% block content %}
    <main class="container py-5">
      <div class="streak-container">
        <h2 class="fw-bold mb-3">Your Login Streak</h2>
        <div class="card p-3" data-streak="{{ studyData.streak | default(0) }}">
          <div class="month-labels" id="month-labels"></div>
          <div class="streak-row">
            <div class="weekday-labels">
              <div></div>
              <div>Mon</div>
              <div></div>
              <div>Wed</div>
              <div></div>
              <div>Fri</div>
              <div></div>
            </div>
            <div class="streak-grid" id="streak-grid">
              <!-- Days will be generated by JS -->
            </div>
          </div>
        </div>
        <div class="streak-legend">
          <div class="streak-day" data-level="0"></div>
          <span>No login</span>
          <div class="streak-day" data-level="1"></div>
          <span>Logged in</span>
        </div>
      </div>

      <!-- gif section -->
      <div class="motivational-section text-center mt-4">
        <img src="https://i.pinimg.com/originals/d5/f5/ae/d5f5ae2e743118a375986e0bb292f1a2.gif"
          alt="Motivational celebration gif" class="motivational-gif mb-3" />
        <div class="motivational-message">
          <p class="h6 text-primary fw-bold mb-1">You're doing amazing!</p>
          <p class="text-muted small">
            Remember why you're doing this âœ© every small step counts toward
            your goals. Keep up the great work! ðŸŒŸ
          </p>
        </div>
      </div>
    </main>

    <footer class="d-md-none fixed-bottom bg-white border-top">
      <nav class="nav justify-content-around py-2">
        <a class="nav-link d-flex flex-column align-items-center text-primary fw-bold"
          href="{{ url_for('home.index') }}"><span class="material-symbols-outlined fs-4">home</span>
          <small class="d-block">Home</small></a>
        <a class="nav-link d-flex flex-column align-items-center text-muted" href="{{ url_for('study.index') }}"><span
            class="material-symbols-outlined fs-4">school</span>
          <small class="d-block">Study</small></a>
        <a class="nav-link d-flex flex-column align-items-center text-muted"
          href="{{ url_for('community.index') }}"><span class="material-symbols-outlined fs-4">groups</span>
          <small class="d-block">Community</small></a>
      </nav>
    </footer>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const grid = document.getElementById("streak-grid");
      const monthLabelsContainer = document.getElementById("month-labels");
      const today = new Date();
      
      // Configuration
      const DAYS_PER_WEEK = 7;
      
      // Get streak data from server
      const streakContainer = document.querySelector(".streak-container .card");
      const streakDays = parseInt(streakContainer.getAttribute("data-streak")) || 0;
      
      // Build a set of logged-in dates (consecutive days from today backwards)
      const loginDates = new Set();
      for (let i = 0; i < streakDays; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        loginDates.add(date.toDateString());
      }

      // Month names
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                          "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

      // =====================================================
      // STEP 1: Set START date to January 1, 2026
      // =====================================================
      // Start from January 1st of the current year (2026)
      const startDate = new Date(2026, 0, 1); // January 1, 2026
      
      // Show full year - 52 weeks
      const NUM_WEEKS = 52;
      
      // =====================================================
      // STEP 2: Generate the grid - COLUMN BY COLUMN
      // =====================================================
      // CSS grid-auto-flow: column means items fill top-to-bottom per column
      
      const allDates = []; // Store dates for month label calculation
      
      // Find the Sunday before or on January 1
      const firstSunday = new Date(startDate);
      firstSunday.setDate(startDate.getDate() - startDate.getDay());
      
      for (let week = 0; week < NUM_WEEKS; week++) {
        for (let dayOfWeek = 0; dayOfWeek < DAYS_PER_WEEK; dayOfWeek++) {
          // Calculate the date for this cell
          const cellDate = new Date(firstSunday);
          cellDate.setDate(firstSunday.getDate() + (week * 7) + dayOfWeek);
          
          // Create the day element
          const dayElement = document.createElement("div");
          dayElement.className = "streak-day";
          
          // Check if date is before Jan 1, 2026 (hide those)
          if (cellDate < startDate) {
            dayElement.classList.add("empty");
            dayElement.dataset.level = "0";
          } else {
            // Check if user was logged in on this date (past dates only)
            const isLoggedIn = cellDate <= today && loginDates.has(cellDate.toDateString());
            dayElement.dataset.level = isLoggedIn ? "1" : "0"; // 0 = grey, 1 = green
            dayElement.title = `${cellDate.toDateString()}: ${isLoggedIn ? "Logged in" : "No login"}`;
          }
          
          grid.appendChild(dayElement);
          
          // Store the first day of each week for month labels
          if (dayOfWeek === 0) {
            allDates.push({ week: week, date: new Date(cellDate) });
          }
        }
      }

      // =====================================================
      // STEP 3: Generate month labels
      // =====================================================
      let lastMonth = -1;
      const cellWidth = 12; // Width of each cell
      const gapWidth = 3;   // Gap between cells
      
      for (const item of allDates) {
        // Skip dates before Jan 1, 2026
        if (item.date < startDate) continue;
        
        const month = item.date.getMonth();
        
        // Only show label when month changes
        if (month !== lastMonth) {
          const label = document.createElement("div");
          label.textContent = monthNames[month];
          // Position using left offset based on week number
          label.style.position = "absolute";
          label.style.left = (item.week * (cellWidth + gapWidth)) + "px";
          monthLabelsContainer.appendChild(label);
          lastMonth = month;
        }
      }

      // =====================================================
      // STEP 4: Initialize Bootstrap tooltips
      // =====================================================
      const tooltipElements = document.querySelectorAll(".streak-day[title]");
      tooltipElements.forEach(function (el) {
        new bootstrap.Tooltip(el);
      });
    });
  </script>
{% endblock %}
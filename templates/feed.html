<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Meta tags for charset and responsive design -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap CSS Framework for responsive layout and components -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Material Symbols Icons library -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <title>Community - Feed | BookMe</title>

  <!-- Custom styles for feed elements -->
  <style>
    /* Post avatar - circular user profile pictures */
    .post-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      /* Make circular */
      object-fit: cover;
      /* Crop image to fill circle */
    }

    /* Images posted in posts */
    .post-image {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 12px;
    }

    /* Like/comment/share action buttons */
    .post-actions button {
      background: none;
      border: none;
      color: #666;
      padding: 8px 16px;
      cursor: pointer;
      transition: color 0.2s;
    }

    /* Button hover effect - change to primary color */
    .post-actions button:hover {
      color: #2badee;
    }
  </style>
</head>

<body class="bg-light">
  <div class="d-flex flex-column min-vh-100">
    <!-- ============================================================================
           HEADER SECTION - Navigation and User Menu
           ============================================================================ -->
      <header class="w-100 bg-white border-bottom">
        <div
          class="container d-flex align-items-center justify-content-between py-3"
        >
          <!-- Logo Section -->
          <a class="col-1 d-flex align-items-center justify-content-center py-3 text-decoration-none" href="{{ url_for('home.index') }}">
              <img src="{{ url_for('static', filename='logo.png') }}" alt="Bookme Logo" class="header-logo-static">
              Bookme
          </a>
          
          <!-- Navigation Links (hidden on mobile, visible on medium+ screens) -->
          <nav class="d-none d-md-flex align-items-center gap-2">
            <!-- Home link -->
            <a
              class="btn btn-sm btn-light rounded-pill"
              href="{{ url_for('home.index') }}"
              >Home</a
            >
            <!-- Study link -->
            <a
              class="btn btn-sm btn-light rounded-pill"
              href="{{ url_for('study.index') }}"
              >Study</a
            >
            <!-- Community link - highlighted as current page -->
            <a
              class="btn btn-sm btn-primary rounded-pill text-white"
              href="{{ url_for('community.index') }}"
              >Community</a
            >
            <!-- Challenges link -->
            <a
              class="btn btn-sm btn-light rounded-pill"
              href="{{ url_for('challenges.index') }}"
              >Challenge</a
            >
          </nav>
          
          <!-- User Controls (Notifications and Profile) -->
          <div class="d-none d-md-flex align-items-center gap-3">
            <!-- Notifications Dropdown -->
            <div class="dropdown">
              <button
                type="button"
                class="btn btn-link text-muted p-0"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="Notifications"
              >
                <span class="material-symbols-outlined">notifications</span>
              </button>
              <ul
                class="dropdown-menu dropdown-menu-end p-3"
                style="width: 300px"
              >
                <li class="text-center text-muted small py-3">
                  No new notifications. <br />Can't start procrastinating now!
                </li>
              </ul>
            </div>
            
            <!-- Profile Dropdown Menu -->
            <div class="dropdown">
              <a
                class="btn btn-link text-muted p-0"
                href="{{ url_for('profile.index') }}"
                id="profileDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="Profile"
              >
                <!-- Account circle icon -->
                <span class="material-symbols-outlined fs-3"
                  >account_circle</span
                >
              </a>
              <!-- Profile menu items -->
              <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Account</h6></li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('profile.index') }}"
                    >Profile & Settings</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <!-- Logout form -->
                <li>
                  <form
                    method="POST"
                    action="{{ url_for('auth.logout') }}"
                    class="m-0"
                  >
                    <button type="submit" class="dropdown-item">Log out</button>
                  </form>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </header>

    <!-- ============================================================================
           MAIN CONTENT AREA
           ============================================================================ -->
    <main class="flex-grow-1">
      <div class="container my-5">
        <!-- Page Title -->
        <div class="d-flex align-items-center justify-content-between mb-4">
          <div>
            <h2 class="h3 mb-0">Community</h2>
            <small class="text-muted">Connect and share knowledge</small>
          </div>
        </div>

        <!-- Navigation Tabs: Notes | Friends | Feed -->
        <ul class="nav nav-tabs mb-4">
          <li class="nav-item">
            <!-- Link to Notes section -->
            <a class="nav-link" href="{{ url_for('community.index') }}">üìù Notes</a>
          </li>
          <li class="nav-item">
            <!-- Link to Friends section -->
            <a class="nav-link" href="{{ url_for('friends.index') }}">üë• Friends</a>
          </li>
          <li class="nav-item">
            <!-- Feed tab - active (current page) -->
            <a class="nav-link active" href="{{ url_for('feed.index') }}">üì∞ Feed</a>
          </li>
        </ul>

        <!-- ============================================================================
               CREATE POST SECTION
               ============================================================================ -->
        <div class="card p-4 mb-4">
          <!-- User avatar + text input -->
          <div class="d-flex align-items-start gap-3 mb-3">
            {% if profileData and profileData.profile_pic %}
            <!-- Show user's uploaded profile picture -->
            <img src="{{ profileData.profile_pic }}" class="post-avatar" alt="Your avatar" />
            {% else %}
            <!-- Generate default avatar from initials if no picture -->
            <img
              src="https://ui-avatars.com/api/?name={{ profileData.name or username }}&background=0D6EFD&color=fff&size=60"
              class="post-avatar" alt="Your avatar" />
            {% endif %}
            <!-- Text input for post content -->
            <textarea id="postText" class="form-control" rows="3"
              placeholder="Share your study progress, notes, or thoughts..."></textarea>
          </div>

          <!-- Image upload input -->
          <div class="mb-3">
            <input type="file" id="postImage" class="form-control" accept="image/*" />
            <small class="text-muted">Optional: Add an image to your post</small>
          </div>
          <div class="d-flex justify-content-end">
            <button class="btn btn-primary" onclick="createPost()">
              <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle">send</span>
              Post
            </button>
          </div>
        </div>

        <!-- Feed Posts -->
        <div id="feedContainer">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="d-md-none d-sm-12" style="height:10vh"></div>
    </main>

    <!-- Mobile Footer -->
    <footer class="d-md-none fixed-bottom bg-white border-top">
      <nav class="nav justify-content-around py-2">
        <a class="nav-link d-flex flex-column align-items-center text-muted" href="{{ url_for('home.index') }}"><span
            class="material-symbols-outlined fs-4">home</span>
          <small class="d-block">Home</small></a>
        <a class="nav-link d-flex flex-column align-items-center text-muted" href="{{ url_for('study.index') }}"><span
            class="material-symbols-outlined fs-4">school</span>
          <small class="d-block">Study</small></a>
        <a class="nav-link d-flex flex-column align-items-center text-muted"
          href="{{ url_for('community.index') }}"><span class="material-symbols-outlined fs-4">groups</span>
          <small class="d-block">Community</small></a>
        <a class="nav-link d-flex flex-column align-items-center text-muted"
          href="{{ url_for('challenges.index') }}"><span class="material-symbols-outlined fs-4">emoji_events</span>
          <small class="d-block">Challenge</small></a>
      </nav>
    </footer>
  </div>

  <!-- Comment Modal -->
  <div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Comments</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="commentList" class="mb-3"></div>
        </div>
        <div class="modal-footer">
          <input type="text" id="commentInput" class="form-control me-2" placeholder="Write a comment..." />
          <button class="btn btn-primary" onclick="submitComment()">
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let activePostId = null;

    // Format timestamp
    function formatPostTime(timestamp) {
      if (!timestamp) return "Just now";
      const postDate = new Date(timestamp);
      const now = new Date();
      const diffMs = now - postDate;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHour = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHour / 24);

      if (diffSec < 60) return "Just now";
      if (diffMin < 60)
        return `${diffMin} minute${diffMin === 1 ? "" : "s"} ago`;
      if (diffHour < 24)
        return `${diffHour} hour${diffHour === 1 ? "" : "s"} ago`;
      if (diffDay < 7) return `${diffDay} day${diffDay === 1 ? "" : "s"} ago`;
      return postDate.toLocaleDateString();
    }

    // Convert file to Data URL
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Create Post
    async function createPost() {
      const textInput = document.getElementById("postText");
      const imageInput = document.getElementById("postImage");
      const text = (textInput?.value || "").trim();

      if (
        !text &&
        !(imageInput && imageInput.files && imageInput.files.length)
      ) {
        alert("Please write something or add an image");
        return;
      }

      let image = null;
      if (imageInput && imageInput.files && imageInput.files[0]) {
        try {
          image = await readFileAsDataURL(imageInput.files[0]);
        } catch (e) {
          console.error("Error reading image:", e);
        }
      }

      try {
        const response = await fetch("/feed/api/feed/posts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, image }),
        });

        if (response.ok) {
          textInput.value = "";
          imageInput.value = "";
          loadFeed();
        } else {
          alert("Failed to create post. Please try again.");
        }
      } catch (e) {
        alert("Network error. Please try again.");
      }
    }

    // Like Post
    async function likePost(postId) {
      try {
        await fetch(`/feed/api/feed/posts/${postId}/like`, {
          method: "POST",
        });
        loadFeed();
      } catch (e) {
        console.error("Error liking post:", e);
      }
    }

    // Open Comments
    async function openComments(postId) {
      activePostId = postId;
      try {
        const res = await fetch(`/feed/api/feed/posts/${postId}`);
        if (!res.ok) throw new Error("Failed to load comments");

        const post = await res.json();
        const list = document.getElementById("commentList");
        list.innerHTML = "";

        const comments = post.comments || [];
        if (!comments.length) {
          list.innerHTML =
            '<div class="text-muted text-center py-3">No comments yet. Be the first to comment!</div>';
        } else {
          comments.forEach((c) => {
            const div = document.createElement("div");
            div.className = "border rounded p-3 mb-2";
            div.innerHTML = `
                            <div class="d-flex align-items-start gap-2">
                                <img src="https://i.pravatar.cc/40?u=${c.author
              }" class="rounded-circle" width="40" height="40" alt="${c.author
              }">
                                <div class="flex-grow-1">
                                    <strong>${c.author}</strong>
                                    <p class="mb-1">${c.text}</p>
                                    <small class="text-muted">${new Date(
                c.timestamp
              ).toLocaleString()}</small>
                                </div>
                            </div>
                        `;
            list.appendChild(div);
          });
        }

        const modalEl = document.getElementById("commentModal");
        let modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (!modalInstance) modalInstance = new bootstrap.Modal(modalEl);
        if (!modalEl.classList.contains("show")) modalInstance.show();
      } catch (e) {
        alert("Failed to load comments.");
      }
    }

    // Submit Comment
    async function submitComment() {
      if (!activePostId) return;

      const inputEl = document.getElementById("commentInput");
      const text = (inputEl?.value || "").trim();

      if (!text) {
        alert("Please write a comment");
        return;
      }

      try {
        const res = await fetch(
          `/feed/api/feed/posts/${activePostId}/comments`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          }
        );

        if (res.ok) {
          inputEl.value = "";
          openComments(activePostId);
          loadFeed();
        } else {
          alert("Failed to submit comment. Please try again.");
        }
      } catch (e) {
        alert("Network error. Please try again.");
      }
    }

    // Load Feed
    async function loadFeed() {
      const container = document.getElementById("feedContainer");

      try {
        const res = await fetch("/feed/api/feed/posts");
        const posts = await res.json();

        if (!posts || posts.length === 0) {
          container.innerHTML = `
                        <div class="card p-5 text-center">
                            <span class="material-symbols-outlined" style="font-size: 64px; color: #ccc;">feed</span>
                            <h5 class="mt-3">No posts yet</h5>
                            <p class="text-muted">Be the first to share something!</p>
                        </div>
                    `;
          return;
        }

        container.innerHTML = "";
        posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "card p-4 mb-4";

          card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center gap-3">
                                ${post.author_profile_pic
              ? `<img src="${post.author_profile_pic}" class="post-avatar" alt="${post.author}">`
              : `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(
                post.author
              )}&background=0D6EFD&color=fff&size=60" class="post-avatar" alt="${post.author
              }">`
            }
                                <div>
                                    <h6 class="mb-0 fw-bold">${post.author}</h6>
                                    <small class="text-muted">${formatPostTime(
              post.timestamp
            )}</small>
                                </div>
                            </div>
                        </div>
                        ${post.text ? `<p class="mb-2">${post.text}</p>` : ""}
                        ${post.image
              ? `<img src="${post.image}" class="post-image" alt="Post image">`
              : ""
            }
                        <hr class="my-3">
                        <div class="d-flex justify-content-between post-actions">
                            <button onclick="likePost('${post._id}')">
                                <span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">thumb_up</span>
                                ${post.likes || 0}
                            </button>
                            <button onclick="openComments('${post._id}')">
                                <span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">comment</span>
                                ${(post.comments || []).length}
                            </button>
                            <button>
                                <span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">share</span>
                                Share
                            </button>
                        </div>
                    `;

          container.appendChild(card);
        });
      } catch (e) {
        container.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading feed</strong><br>
                        Please refresh the page or try again later.
                    </div>
                `;
      }
    }

    // Load feed on page load
    document.addEventListener("DOMContentLoaded", loadFeed);
  </script>
</body>

</html>
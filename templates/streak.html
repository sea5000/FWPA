{% extends "base.html" %}

{% block title %}Bookme - Streak{% endblock %}

{% block head %}
    <!-- Streak-specific styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles-streak.css') }}" />
{% endblock %}

{% block body_attrs %}class="bg-light text-dark"{% endblock %}

{% block content %}
    <main class="container py-5">
      <div class="streak-container">
        <h2 class="fw-bold mb-3">Your Login Streak</h2>
        <div class="card p-3" data-streak="{{ studyData.streak | default(0) }}">
          <div class="month-labels" id="month-labels"></div>
          <div class="d-flex gap-2">
            <div class="weekday-labels">
              <div></div>
              <div>Mon</div>
              <div></div>
              <div>Wed</div>
              <div></div>
              <div>Fri</div>
              <div></div>
            </div>
            <div class="streak-grid" id="streak-grid">
              <!-- Days will be generated by JS -->
            </div>
          </div>
        </div>
        <div class="streak-legend">
          <span class="text-muted small">No login</span>
          <div class="streak-day" data-level="0"></div>
          <div class="streak-day" data-level="1"></div>
          <span class="text-muted small">Logged in</span>
        </div>
      </div>

      <!-- gif section -->
      <div class="motivational-section text-center mt-4">
        <img src="https://i.pinimg.com/originals/d5/f5/ae/d5f5ae2e743118a375986e0bb292f1a2.gif"
          alt="Motivational celebration gif" class="motivational-gif mb-3" />
        <div class="motivational-message">
          <p class="h6 text-primary fw-bold mb-1">You're doing amazing!</p>
          <p class="text-muted small">
            Remember why you're doing this âœ© every small step counts toward
            your goals. Keep up the great work! ðŸŒŸ
          </p>
        </div>
      </div>
    </main>

    <footer class="d-md-none fixed-bottom bg-white border-top">
      <nav class="nav justify-content-around py-2">
        <a class="nav-link d-flex flex-column align-items-center text-primary fw-bold"
          href="{{ url_for('home.index') }}"><span class="material-symbols-outlined fs-4">home</span>
          <small class="d-block">Home</small></a>
        <a class="nav-link d-flex flex-column align-items-center text-muted" href="{{ url_for('study.index') }}"><span
            class="material-symbols-outlined fs-4">school</span>
          <small class="d-block">Study</small></a>
        <a class="nav-link d-flex flex-column align-items-center text-muted"
          href="{{ url_for('community.index') }}"><span class="material-symbols-outlined fs-4">groups</span>
          <small class="d-block">Community</small></a>
      </nav>
    </footer>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const grid = document.getElementById("streak-grid");
      const monthLabelsContainer = document.getElementById("month-labels");
      const today = new Date();
      const daysInGrid = 371; // 53 weeks * 7 days

      // Use server-provided streak data from data attribute
      const streakContainer = document.querySelector(
        ".streak-container .card"
      );
      const streakDays =
        parseInt(streakContainer.getAttribute("data-streak")) || 0;
      const loginDays = new Set();

      // Populate loginDays: mark consecutive days starting from today going backwards
      // Only track login days, not minutes
      for (let i = 0; i < streakDays && i < daysInGrid; i++) {
        const date = new Date();
        date.setDate(today.getDate() - i);
        // Mark this day as logged in
        loginDays.add(date.toLocaleDateString());
      }

      function getLevel(isLoggedIn) {
        // Binary: 0 = not logged in, 1 = logged in
        return isLoggedIn ? 1 : 0;
      }

      const monthLabels = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ];
      const visibleMonths = new Array(12).fill(0);

      for (let i = 0; i < daysInGrid; i++) {
        const date = new Date();
        date.setDate(today.getDate() - (daysInGrid - 1 - i));
        const isLoggedIn = loginDays.has(date.toLocaleDateString());
        const level = getLevel(isLoggedIn);

        const day = document.createElement("div");
        day.className = "streak-day";
        day.dataset.level = level;
        day.title = isLoggedIn
          ? `${date.toDateString()}: Logged in`
          : `${date.toDateString()}: No login`;
        grid.appendChild(day);

        // For month labels
        if (date.getDate() === 1) {
          visibleMonths[date.getMonth()]++;
        }
      }

      let lastMonth = -1;
      for (let i = 0; i < 53; i++) {
        const date = new Date();
        date.setDate(today.getDate() - (daysInGrid - 1) + i * 7);
        const month = date.getMonth();
        if (month !== lastMonth) {
          const label = document.createElement("div");
          label.textContent = monthLabels[month];
          label.style.gridColumn = i + 1;
          monthLabelsContainer.appendChild(label);
          lastMonth = month;
        }
      }

      const tooltipTriggerList = [].slice.call(
        document.querySelectorAll("[title]")
      );
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });
  </script>
{% endblock %}
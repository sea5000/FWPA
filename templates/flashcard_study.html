{% extends "base.html" %}

{% block title %}Bookme Dashboard{% endblock %}

{% block head %}
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
{% endblock %}

{% block body_attrs %}class="bg-light text-dark"{% endblock %}

{% block content %}
        <main>
            <div class="container p-4">
                <div class="row">
                    <div class="col">
                        <!-- col-12 col-lg-8 -->
                        <div class=" medium text-muted mb-1">Title:</div>
                        <h2 class="h2 fw-bold">{{deck.name}}</h2>
                        <div class="medium text-muted mb-1">Summary:</div>
                        <t class="text-muted mt-1">{{deck.summary}}</t>
                    </div>
                    <div class="col-sm text-center align-content-center">
                        <div class="d-flex justify-content-center justify-content-md-end gap-2">
                            <a href="{{ url_for('flashcards.index', deck_id = deck_id) }}"
                                class="btn btn-outline-warning btn-md d-md-flex d-sm-inline-grid rounded-pill d-inline-flex align-items-center gap-2">
                                <span class="material-symbols-outlined" aria-hidden="true"
                                    style="font-size:18px;">Arrow_back</span>
                                <span class="fw-semibold">Back to Decks</span>
                            </a>
                            {% if deck.id in permissions.editor %}
                            <a href="{{ url_for('flashcards.edit', deck_id = deck_id) }}"
                                class="btn btn-success btn-md d-md-flex  d-sm-inline-grid rounded-pill d-inline-flex align-items-center gap-2">
                                <span class="material-symbols-outlined" aria-hidden="true"
                                    style="font-size:18px;">edit</span>
                                <span class="fw-semibold">Edit</span>
                            </a>
                            <a role="button" id="deleteBtn"
                                class="btn btn-outline-danger btn-sm rounded-pill d-inline-flex align-items-center gap-2">
                                <span class="material-symbols-outlined" aria-hidden="true"
                                    style="font-size:18px;">delete</span>
                                <span>Delete</span>
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="d-flex flex-column ">
                            <hr class="">
                            <div class="card col-12 mh-80 mx-auto" style="max-width:720px;">
                                <div class="card-body text-center">
                                    <div id="study-counter" class="mb-2 text-muted small">Card <span
                                            id="current-index">0</span> / <span id="total-cards">0</span></div>
                                    <h6 id="card-front" class="text-muted">Front</h6>
                                    <p id="card-front-text" class="card-text fs-5"></p>

                                    <div id="answer-area" class="mt-4 d-none">
                                        <h6 class="text-muted">Answer</h6>
                                        <p id="card-back-text" class="fs-5"></p>
                                    </div>

                                    <div class="mt-4 d-flex justify-content-center gap-2">
                                        <button id="show-answer" class="btn btn-outline-primary">Show answer</button>
                                        <button id="correct-btn" class="btn btn-success d-none">Correct</button>
                                        <button id="incorrect-btn" class="btn btn-danger d-none">Incorrect</button>
                                    </div>
                                </div>
                            </div>

                            <script>
                                const STUDY_CARDS = [
                                    {% for cid, card in deck.cards.items() %}
                                { "id": {{ cid | tojson }}, "front": {{ card.front | tojson }}, "back": {{ card.back | tojson }} }{% if not loop.last %},{% endif %}
                                {% endfor %}
                                ];

                                (function () {
                                    let idx = 0;
                                    const totalEl = document.getElementById('total-cards');
                                    const currEl = document.getElementById('current-index');
                                    const frontText = document.getElementById('card-front-text');
                                    const backText = document.getElementById('card-back-text');
                                    const answerArea = document.getElementById('answer-area');
                                    const showBtn = document.getElementById('show-answer');
                                    const correctBtn = document.getElementById('correct-btn');
                                    const incorrectBtn = document.getElementById('incorrect-btn');

                                    const deckId = `{{ deck_id }}`;
                                    const reviewUrl = `{{ url_for('flashcards.flashcards_review') }}`;

                                    function render() {
                                        if (STUDY_CARDS.length === 0) {
                                            document.getElementById('card-front-text').textContent = 'No cards in this deck.';
                                            showBtn.disabled = true;
                                            return;
                                        }
                                        if (idx < 0) idx = 0;
                                        if (idx >= STUDY_CARDS.length) idx = 0; // loop
                                        const c = STUDY_CARDS[idx];
                                        totalEl.textContent = STUDY_CARDS.length;
                                        currEl.textContent = idx + 1;
                                        frontText.textContent = c.front;
                                        backText.textContent = c.back;
                                        answerArea.classList.add('d-none');
                                        showBtn.classList.remove('d-none');
                                        correctBtn.classList.add('d-none');
                                        incorrectBtn.classList.add('d-none');
                                    }

                                    function postReview(cardId, correct) {
                                        fetch(reviewUrl, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ deck_id: deckId, card_id: cardId, correct: correct })
                                        }).then(r => r.json()).then(data => {
                                            // ignore returned details for now; advance to next card
                                            idx = (idx + 1) % STUDY_CARDS.length;
                                            render();
                                        }).catch(err => {
                                            console.error('Review error', err);
                                            // still advance
                                            idx = (idx + 1) % STUDY_CARDS.length;
                                            render();
                                        });
                                    }

                                    showBtn.addEventListener('click', function () {
                                        answerArea.classList.remove('d-none');
                                        showBtn.classList.add('d-none');
                                        correctBtn.classList.remove('d-none');
                                        incorrectBtn.classList.remove('d-none');
                                    });

                                    correctBtn.addEventListener('click', function () {
                                        const c = STUDY_CARDS[idx];
                                        postReview(c.id, true);
                                    });
                                    incorrectBtn.addEventListener('click', function () {
                                        const c = STUDY_CARDS[idx];
                                        postReview(c.id, false);
                                    });

                                    // initial render
                                    document.addEventListener('DOMContentLoaded', render);
                                })();
                            </script>
                        </div>
                    </div>
                </div>
                <!-- Confirm Delete Modal (simple custom modal so no extra bootstrap JS required) -->
                <div id="confirmDeleteModal" class="position-fixed top-0 start-0 w-100 h-100 d-none"
                    style="z-index:1050;background:rgba(0,0,0,0.45);">
                    <div class="d-flex align-items-center justify-content-center h-100 p-3">
                        <div class="bg-white rounded shadow-sm p-4" style="max-width:480px; width:100%;">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="m-0">Can you confirm deletion?</h5>
                                <button type="button" class="btn-close" id="closeDeleteModal"
                                    aria-label="Close"></button>
                            </div>
                            <p class="mb-3">Are you sure you want to delete this deck?
                                This action cannot be undone.</p>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-light btn-sm" id="cancelDelete">Cancel</button>
                                <form method="POST" action="{{ url_for('flashcards.delete', deck_id = deck_id) }}"
                                    class="m-0">
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="d-md-none d-sm-12" style="height:10vh"></div>
        </main>
        <footer class="d-md-none fixed-bottom bg-white border-top">
            <nav class="nav justify-content-around py-2">
                <a class="nav-link d-flex flex-column align-items-center text-muted"
                    href="{{ url_for('home.index') }}"><span class="material-symbols-outlined fs-4">home</span> <small
                        class="d-block">Home</small></a> <a
                    class="nav-link d-flex flex-column align-items-center text-muted"
                    href="{{ url_for('study.index') }}"><span class="material-symbols-outlined fs-4">school</span>
                    <small class="d-block">Study</small></a> <a
                    class="nav-link d-flex flex-column align-items-center text-muted"
                    href="{{ url_for('community.index') }}"><span class="material-symbols-outlined fs-4">groups</span>
                    <small class="d-block">Community</small></a>
            </nav>
        </footer>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='flashcards.js') }}"></script>
    <script>

        // Highlight header/footer nav link using the folder slug
        document.addEventListener('DOMContentLoaded', function () {
            try {
                const navAreas = [];
                const header = document.querySelector('header');
                if (header) navAreas.push(header);
                const footers = Array.from(document.querySelectorAll('footer'));
                navAreas.push(...footers);

                const parts = location.pathname.split('/').filter(Boolean);
                const currentSlug = parts.length >= 2 ? parts[parts.length - 2] : (parts[0] || 'home');

                navAreas.forEach(area => {
                    const links = Array.from(area.querySelectorAll('a[href]'));
                    links.forEach(a => {
                        try {
                            if (a.id === "logoButton") return;
                            const url = new URL(a.getAttribute('href'), location.origin);
                            const linkParts = url.pathname.split('/').filter(Boolean);
                            const linkSlug = linkParts.length >= 2 ? linkParts[linkParts.length - 2] : (linkParts[0] || 'home');

                            a.classList.remove('active', 'text-primary', 'fw-bold', 'text-white', 'btn-primary');

                            if (linkSlug === currentSlug) {
                                if (a.classList.contains('btn')) {
                                    a.classList.remove('btn-light');
                                    a.classList.add('btn-primary', 'text-white');
                                } else {
                                    a.classList.add('text-primary', 'fw-bold');
                                }
                                a.classList.add('active');
                            } else {
                                if (!a.classList.contains('btn')) {
                                    a.classList.remove('text-primary', 'fw-bold');
                                    a.classList.add('text-muted');
                                }
                                if (a.classList.contains('btn') && !a.classList.contains('btn-light')) {
                                    a.classList.add('btn-light');
                                }
                            }
                        } catch (e) { }
                    });
                });
            } catch (e) { }
        });
    </script>
{% endblock %}
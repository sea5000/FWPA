<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?display=swap&amp;family=Plus+Jakarta+Sans:wght@400;500;700;800"
        rel="stylesheet"> -->

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <style>
      .follow-btn.following {
        background-color: #198754; /* Green color */
        border-color: #198754;
        animation: pop-in 0.3s ease-out;
      }

      @keyframes pop-in {
        0% {
          transform: scale(0.9);
          opacity: 0.8;
        }
        70% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .follow-btn.following:hover {
        background-color: #dc3545; /* Bootstrap danger red */
        border-color: #dc3545;
        animation: none; /* Disable pop-in on hover */
      }
    </style>
    <title>Community - Friends | BookMe</title>
  </head>

  <body class="bg-light">
    <div class="d-flex flex-column min-vh-100">
      <!-- Header -->
      <header class="w-100 bg-white border-bottom">
        <div
          class="container d-flex align-items-center justify-content-between py-3"
        >
          <div
            class="col-1 d-flex align-items-center justify-content-center py-3"
          >
            <div
              class="col-1"
              style="width: 40px; height: 40px; color: var(--bs-primary)"
            >
              <span class="material-symbols-outlined fs-3 text-primary"
                >book</span
              >
            </div>
            <a
              class="col-1 h3 text-decoration-none text-reset fw-bold"
              id="logoButton"
              href="{{ url_for('home.index') }}"
              >Bookme</a
            >
          </div>
          <nav class="d-none d-md-flex align-items-center gap-2">
            <a
              class="btn btn-sm btn-light rounded-pill"
              href="{{ url_for('home.index') }}"
              >Home</a
            >
            <a
              class="btn btn-sm btn-light rounded-pill"
              href="{{ url_for('study.index') }}"
              >Study</a
            >
            <a
              class="btn btn-sm btn-primary rounded-pill text-white"
              href="{{ url_for('community.index') }}"
              >Community</a
            >
            <a
              class="btn btn-sm btn-light rounded-pill"
              href="{{ url_for('challenges.index') }}"
              >Challenge</a
            >
          </nav>
          <div class="d-none d-md-flex align-items-center gap-3">
            <div class="dropdown">
              <button
                type="button"
                class="btn btn-link text-muted p-0"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="Notifications"
              >
                <span class="material-symbols-outlined">notifications</span>
              </button>
              <ul
                class="dropdown-menu dropdown-menu-end p-3"
                style="width: 300px"
              >
                <li class="text-center text-muted small py-3">
                  No new notifications. <br />Can't start procrastinating now!
                </li>
              </ul>
            </div>
            <div class="dropdown">
              <a
                class="btn btn-link text-muted p-0 dropdown-toggle"
                href="{{ url_for('profile.index') }}"
                id="profileDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="Profile"
              >
                <span class="material-symbols-outlined fs-3"
                  >account_circle</span
                >
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <h6 class="dropdown-header">Account</h6>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('profile.index') }}"
                    >Profile & Settings</a
                  >
                </li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li>
                  <form
                    method="POST"
                    action="{{ url_for('auth.logout') }}"
                    class="m-0"
                  >
                    <button type="submit" class="dropdown-item">Log out</button>
                  </form>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex-grow-1">
        <div class="container my-5">
          <!-- Page Header -->
          <div class="d-flex align-items-center justify-content-between mb-4">
            <div>
              <h2 class="h3 mb-0">Community</h2>
              <small class="text-muted">Connect and share knowledge</small>
            </div>
          </div>

          <!-- Navigation Tabs -->
          <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('community.index') }}"
                >üìù Notes</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="{{ url_for('friends.index') }}"
                >üë• Friends</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('feed.index') }}">üì∞ Feed</a>
            </li>
          </ul>

          <!-- Friends Section -->
          <div class="row mb-4">
            <div class="col-12">
              <h4 class="mb-3">Study Community</h4>
            </div>
          </div>

          <!-- Search Bar -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="input-group">
                <span class="input-group-text">
                  <span
                    class="material-symbols-outlined"
                    style="font-size: 1.2rem"
                    >search</span
                  >
                </span>
                <input
                  type="text"
                  id="friendSearch"
                  class="form-control"
                  placeholder="Find friends by @username..."
                />
              </div>
            </div>
          </div>

          <!-- Friends Grid -->
          <div class="row g-4" id="friendsGrid">
            {% if users %} {% for user in users %} {% if user.username !=
            username %}
            <div class="col-md-6 col-lg-4 user-card">
              <div class="card h-100">
                <div class="card-body text-center">
                  <div class="mb-3">
                    {% if user.profile_pic %}
                    <img
                      src="{{ user.profile_pic }}"
                      alt="{{ user.name }}"
                      class="rounded-circle"
                      width="80"
                      height="80"
                      style="object-fit: cover"
                    />
                    {% else %}
                    <span
                      class="material-symbols-outlined"
                      style="font-size: 64px; color: #2badee"
                      >account_circle</span
                    >
                    {% endif %}
                  </div>
                  <h5 class="card-title mb-1">
                    {{ user.name or user.username }}
                  </h5>
                  <p class="text-muted small mb-2">@{{ user.username }}</p>

                  <!-- Streak Badge -->
                  {% if user.studyData and user.studyData.streak %}
                  <div class="badge bg-warning text-dark mb-2">
                    üî• {{ user.studyData.streak }} day streak
                  </div>
                  {% endif %}

                  <!-- Bio -->
                  {% if user.bio %}
                  <p class="text-muted small mb-3" style="font-size: 0.85rem">
                    {{ user.bio[:60] }}{% if user.bio|length > 60 %}...{% endif
                    %}
                  </p>
                  {% else %}
                  <p class="text-muted small mb-3">BookMe member</p>
                  {% endif %}

                  <div class="d-flex gap-2 justify-content-center">
                    <button
                      class="btn btn-primary btn-sm follow-btn"
                      data-username="{{ user.username }}"
                      onclick="toggleFollow(this)"
                    >
                      <span
                        class="material-symbols-outlined"
                        style="font-size: 16px"
                        >person_add</span
                      >
                      Follow
                    </button>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      onclick="viewProfile('{{ user.username }}')"
                    >
                      View Profile
                    </button>
                  </div>
                </div>
              </div>
            </div>
            {% endif %} {% endfor %} {% else %}
            <div class="col-12">
              <div class="alert alert-info" id="noUsersMessage">
                No other users found. Invite your friends to join BookMe!
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Following Section -->
          <div class="row mt-5">
            <div class="col-12">
              <h4 class="mb-3">People You Follow</h4>
              <div id="followingContainer">
                <div class="alert alert-secondary">
                  You're not following anyone yet. Start following people to see
                  their posts in your feed!
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Mobile Footer -->
      <footer class="d-md-none fixed-bottom bg-white border-top">
        <nav class="nav justify-content-around py-2">
          <a class="nav-link text-muted" href="{{ url_for('home.index') }}">
            <span class="material-symbols-outlined">home</span>
            <small class="d-block">Home</small>
          </a>
          <a class="nav-link text-muted" href="{{ url_for('study.index') }}">
            <span class="material-symbols-outlined">school</span>
            <small class="d-block">Study</small>
          </a>
          <a
            class="nav-link text-primary"
            href="{{ url_for('community.index') }}"
          >
            <span class="material-symbols-outlined">groups</span>
            <small class="d-block">Community</small>
          </a>
          <a
            class="nav-link text-muted"
            href="{{ url_for('challenges.index') }}"
          >
            <span class="material-symbols-outlined">emoji_events</span>
            <small class="d-block">Challenge</small>
          </a>
        </nav>
      </footer>
    </div>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("friendSearch");
        const friendsGrid = document.getElementById("friendsGrid");
        const userCards = friendsGrid.querySelectorAll(".user-card");
        const followingContainer =
          document.getElementById("followingContainer");

        function getFollowingList() {
          return JSON.parse(localStorage.getItem("following") || "[]");
        }

        function setFollowingList(list) {
          localStorage.setItem("following", JSON.stringify(list));
        }

        function updateFollowingSection() {
          const following = getFollowingList();
          if (following.length > 0) {
            followingContainer.innerHTML = following
              .map(
                (user) => `
                        <div class="card mb-2">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-3">
                                    <span class="material-symbols-outlined" style="font-size: 40px; color: #2badee;">account_circle</span>
                                    <div>
                                        <h6 class="mb-0">${user}</h6>
                                        <small class="text-muted">Following</small>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="unfollowUser('${user}')">Unfollow</button>
                            </div>
                        </div>
                    `
              )
              .join("");
          } else {
            followingContainer.innerHTML = `
                        <div class="alert alert-secondary">
                            You're not following anyone yet. Start following people to see their posts in your feed!
                        </div>
                    `;
          }
        }

        function updateAllFollowButtons() {
          const following = getFollowingList();
          document.querySelectorAll(".follow-btn").forEach((button) => {
            const username = button.dataset.username;
            if (following.includes(username)) {
              setButtonToFollowing(button);
            } else {
              setButtonToFollow(button);
            }
          });
        }

        function setButtonToFollowing(button) {
          button.classList.add("following");
          button.innerHTML = `<span class="material-symbols-outlined" style="font-size: 16px;">check</span> Following`;
          button.onmouseover = () => {
            button.innerHTML = `<span class="material-symbols-outlined" style="font-size: 16px;">person_remove</span> Unfollow`;
          };
          button.onmouseout = () => {
            button.innerHTML = `<span class="material-symbols-outlined" style="font-size: 16px;">check</span> Following`;
          };
        }

        function setButtonToFollow(button) {
          button.classList.remove("following");
          button.innerHTML = `<span class="material-symbols-outlined" style="font-size: 16px;">person_add</span> Follow`;
          button.onmouseover = null;
          button.onmouseout = null;
        }

        window.toggleFollow = function (button) {
          const username = button.dataset.username;
          const following = getFollowingList();
          if (following.includes(username)) {
            // Unfollow
            const updatedList = following.filter((u) => u !== username);
            setFollowingList(updatedList);
            setButtonToFollow(button);
          } else {
            // Follow
            following.push(username);
            setFollowingList(following);
            setButtonToFollowing(button);
          }
          updateFollowingSection();
        };

        window.unfollowUser = function (username) {
          let following = getFollowingList();
          following = following.filter((u) => u !== username);
          setFollowingList(following);

          const buttonInGrid = document.querySelector(
            `.follow-btn[data-username="${username}"]`
          );
          if (buttonInGrid) {
            setButtonToFollow(buttonInGrid);
          }
          updateFollowingSection();
        };

        window.viewProfile = function (username) {
          // TODO: Implement profile view
          alert(`Viewing profile of ${username} (Feature coming soon)`);
        };

        // Friend search functionality
        searchInput.addEventListener("keyup", function () {
          const searchTerm = searchInput.value.toLowerCase();
          let visibleCards = 0;
          const shouldSearch =
            searchTerm.startsWith("@") && searchTerm.length > 1;

          userCards.forEach((card) => {
            const username = card
              .querySelector(".text-muted.small")
              .textContent.toLowerCase();
            const isVisible = !shouldSearch || username.includes(searchTerm);
            card.style.display = isVisible ? "" : "none";
            if (isVisible) visibleCards++;
          });
        });

        // Initial Page Setup
        updateAllFollowButtons();
        updateFollowingSection();
      });
    </script>
  </body>
</html>

{% extends "base.html" %}

{% block title %}Focus Timer | BookMe{% endblock %}

{% block head %}
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bookme-blue: #8ecae6;
        --bookme-deep-blue: #023047;
        --bookme-yellow: #ffb703;
        --bookme-soft-yellow: #ffeaae;
        --bookme-charcoal: #333333;
      }
      
      /* Fix global scrolling for this page only */
      body {
        overflow: hidden; /* Prevent scrolling on the page body */
      }

      /* Base layout override to lock height */
      .d-flex.flex-column.min-vh-100 {
        height: 100vh;
        overflow: hidden;
      }

      /* 
         TIMER WRAPPER
         Flex content to fill space below header.
         We do NOT touch the header styles.
      */
      .timer-wrapper {
        flex: 1;
        display: flex;
        flex-direction: row;
        overflow: hidden;
        height: 100%;
        /* Only apply custom font to this section */
        font-family: "Plus Jakarta Sans", sans-serif;
      }
      
      /* Apply font ONLY to elements INSIDE the timer wrapper 
         EXCLUDING material icons/symbols which need their own font */
      .timer-wrapper *:not(.material-symbols-outlined) {
        font-family: "Plus Jakarta Sans", sans-serif;
      }

      /* Main Timer Area */
      .timer-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        padding-top: 1rem;
        padding-bottom: 2rem;
      }

      .tab-btn {
        background: none;
        border: none;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.25em;
        padding-bottom: 0.5rem;
        text-transform: uppercase;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
        color: #9ca3af;
      }
      
      .tab-btn.active {
        color: var(--bookme-deep-blue);
        border-bottom-color: var(--bookme-yellow);
      }

      .tab-btn:hover:not(.active) {
        color: var(--bookme-blue);
      }

      /* Timer SVG & Inputs */
      .timer-container {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: auto; 
        transform: translateY(-15px);
      }

      /* Responsive SVG sizing to ensure fit without scroll */
      .timer-svg {
        width: 350px;
        height: 350px;
        transform: rotate(-90deg);
        /* Critical: scale down on smaller vertical screens */
        max-width: 60vh;
        max-height: 60vh;
      }

      .timer-input-wrapper {
        position: absolute;
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-top: 1rem;
      }

      #timer-input {
        background: transparent;
        border: none;
        text-align: center;
        color: #1a1a1a;
        font-size: 5rem;
        font-weight: 700;
        line-height: 1;
        width: 100%;
        max-width: 300px;
        outline: none;
      }

      /* Scale text with viewport height */
      @media (max-height: 700px) {
        #timer-input { font-size: 3.5rem; }
        .timer-svg { width: 280px; height: 280px; }
      }

      #focus-input {
        background: transparent;
        border: none;
        text-align: center;
        color: #444;
        font-size: 1.1rem;
        font-weight: 500;
        width: 100%;
        max-width: 250px;
        outline: none;
        margin-top: 1rem;
      }

      .focus-line {
        width: 50px;
        height: 2px;
        background-color: #e5e7eb;
        margin-top: 0.5rem;
      }

      /* Controls */
      .timer-controls {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        margin-top: 2rem;
      }

      .btn-circle {
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: transform 0.1s;
        cursor: pointer;
      }
      .btn-circle:active { transform: scale(0.95); }

      #start { width: 80px; height: 80px; background-color: var(--bookme-yellow); color: white; border: none;}
      #pause { width: 80px; height: 80px; background-color: var(--bookme-blue); color: white; border: none;}
      #reset { width: 50px; height: 50px; background-color: white; color: #666; border: 1px solid #eee;}

      /* Sidebar */
      .sidebar {
        width: 350px;
        background: white;
        border-left: 1px solid #f3f4f6;
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
        z-index: 10;
        box-shadow: -2px 0 10px rgba(0,0,0,0.02);
      }

      .stat-box {
        background: #f9fafb;
        border: 1px solid #f3f4f6;
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
      }
      
      .stat-label { font-size: 0.7rem; font-weight: 700; color: var(--bookme-blue); text-transform: uppercase; letter-spacing: 0.05em; }
      .stat-val { font-size: 1.5rem; font-weight: 700; color: #1a1a1a; line-height: 1.2; }
      
      .leaderboard-item {
        background: #f9fafb;
        border: 1px solid #f3f4f6;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      /* Responsive Adjustments */
      @media (max-width: 991px) {
        .timer-wrapper { flex-direction: column; height: auto; overflow-y: auto; }
        .sidebar { width: 100%; border-left: none; border-top: 1px solid #f3f4f6; padding-bottom: 80px; }
        .timer-svg { width: 280px; height: 280px; }
        #timer-input { font-size: 4rem; }
        
        /* On mobile, we MUST allow scrolling because content is taller than screen */
        body { overflow: auto; }
        .d-flex.flex-column.min-vh-100 { height: auto; overflow: visible; }
        .timer-main { height: auto; min-height: 60vh; }
      }
    </style>

{% endblock %}

{% block body_attrs %}class="antialiased"{% endblock %}

{% block content %}
  <div class="timer-wrapper">
    <!-- Main Focus Area -->
    <div class="timer-main">
      <!-- Tabs -->
      <div class="d-flex gap-4 mb-3">
        <button id="focus-tab" class="tab-btn active">FOCUS</button>
        <button id="break-tab" class="tab-btn">BREAK</button>
      </div>

      <!-- Timer Circle -->
      <div class="timer-container">
        <svg class="timer-svg">
          <circle cx="50%" cy="50%" r="48%" fill="transparent" stroke="#e5e7eb" stroke-width="6"></circle>
          <circle id="progress-circle" cx="50%" cy="50%" r="48%" fill="transparent" stroke="#ffb703" stroke-width="8"
                  stroke-dasharray="1150" stroke-dashoffset="1150" stroke-linecap="round" 
                  style="transition: stripe-dashoffset 0.3s ease;"></circle>
        </svg>
        
        <div class="timer-input-wrapper">
          <input type="text" id="timer-input" placeholder="25:00" value="25:00">
          <div class="d-flex flex-column align-items-center w-100">
            <input id="focus-input" type="text" placeholder="I will focus on...">
            <div class="focus-line"></div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="timer-controls">
        <button id="start" class="btn-circle">
          <span class="material-symbols-outlined fs-2">play_arrow</span>
        </button>
        <button id="pause" class="btn-circle d-none">
          <span class="material-symbols-outlined fs-2">pause</span>
        </button>
        <button id="reset" class="btn-circle">
          <span class="material-symbols-outlined fs-5">refresh</span>
        </button>
      </div>
    </div>

    <!-- Right Sidebar -->
    <aside class="sidebar d-none d-lg-flex">
      <h6 class="fw-bold mb-3" style="color: #333;">üìä Today's Progress</h6>
      <div class="row g-2 mb-4">
        <div class="col-6">
          <div class="stat-box">
            <div class="stat-label">Study Time</div>
            <div class="stat-val"><span id="daily-time">0</span><small class="fs-6 text-muted fw-normal ms-1">min</small></div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-box">
            <div class="stat-label">Streak</div>
            <div class="stat-val"><span id="streak">0</span><small class="fs-6 text-muted fw-normal ms-1">days</small></div>
          </div>
        </div>
      </div>

      <h6 class="fw-bold mb-3" style="color: #333;">üèÜ Top Sessions</h6>
      <div id="leaderboard-container" class="flex-grow-1 overflow-auto pe-2" style="max-height: 40vh;">
        <!-- JS Injected -->
      </div>

      <div class="mt-4 pt-3 border-top text-center">
        <small class="text-muted fst-italic">Now is the time to move toward my goals</small>
      </div>
    </aside>
  </div>

  <!-- Mobile Footer Spacer -->
  <div class="d-md-none" style="height: 80px;"></div>
  
  <!-- Mobile Footer -->
  <footer class="d-md-none fixed-bottom bg-white border-top">
    <nav class="nav justify-content-around py-2">
      <a class="nav-link text-muted" href="{{ url_for('home.index') }}">
        <span class="material-symbols-outlined">home</span>
        <small class="d-block">Home</small>
      </a>
      <a class="nav-link text-muted" href="{{ url_for('study.index') }}">
        <span class="material-symbols-outlined">school</span>
        <small class="d-block">Study</small>
      </a>
      <a class="nav-link text-muted" href="{{ url_for('community.index') }}">
        <span class="material-symbols-outlined">groups</span>
        <small class="d-block">Community</small>
      </a>
    </nav>
  </footer>
{% endblock %}

{% block scripts %}
  <script>
    // TIMER LOGIC
    let timer = null;
    let running = false;
    let timeLeft = 25 * 60; // Default 25m
    let duration = 25 * 60;
    let totalSeconds = 0;
    let isBreakMode = false;

    const display = document.getElementById("timer-input");
    const progressCircle = document.getElementById("progress-circle");
    const startBtn = document.getElementById("start");
    const pauseBtn = document.getElementById("pause");
    const resetBtn = document.getElementById("reset");
    const focusTab = document.getElementById("focus-tab");
    const breakTab = document.getElementById("break-tab");

    // Circle circumference (2 * PI * radius), radius = 48% of 380 = ~182px -> circ ~1150
    // Note: SVG scaling might affect this but stroke-dasharray is relative to viewport units usually or path length
    // We will assume 1150 based on previous code usually works for this radius
    const circleCircumference = 1150; 

    function formatMMSS(seconds) {
      const mm = Math.floor(seconds / 60).toString().padStart(2, '0');
      const ss = (seconds % 60).toString().padStart(2, '0');
      return `${mm}:${ss}`;
    }

    function updateProgressCircle() {
      if (duration > 0) {
        const progress = (1 - timeLeft / duration);
        const offset = circleCircumference - (progress * circleCircumference);
        progressCircle.style.strokeDashoffset = offset;
      } else {
        progressCircle.style.strokeDashoffset = circleCircumference;
      }
    }

    function parseTimeInput(value) {
      if (!value || value.trim() === '') return 0;
      const trimmed = value.trim();
      if (trimmed.includes(':')) {
        const [mm, ss] = trimmed.split(':').map(n => parseInt(n) || 0);
        return Math.max(0, mm * 60 + ss);
      }
      const minutes = parseFloat(trimmed);
      return isNaN(minutes) ? 0 : Math.max(0, Math.round(minutes * 60));
    }

    function switchToFocusMode() {
      isBreakMode = false;
      focusTab.classList.add('active');
      breakTab.classList.remove('active');
      progressCircle.setAttribute("stroke", "#ffb703");
      
      if (!running) {
        timeLeft = 25 * 60;
        duration = timeLeft;
        display.value = "25:00";
        updateProgressCircle();
      }
    }

    function switchToBreakMode() {
      isBreakMode = true;
      breakTab.classList.add('active');
      focusTab.classList.remove('active');
      progressCircle.setAttribute("stroke", "#8ecae6");
      
      if (!running) {
        timeLeft = 5 * 60;
        duration = timeLeft;
        display.value = "05:00";
        updateProgressCircle();
      }
    }

    function startTimer() {
      if (running) return;
      
      // Parse current display if user edited it
      if(!running) {
          const secs = parseTimeInput(display.value);
          if (secs > 0) {
              timeLeft = secs;
              duration = secs; // Set new max duration based on edit
          }
      }
      
      running = true;
      
      // Toggle buttons
      startBtn.classList.add('d-none');
      pauseBtn.classList.remove('d-none');
      
      timer = setInterval(() => {
        if (timeLeft > 0) {
          timeLeft--;
          totalSeconds++;
          display.value = formatMMSS(timeLeft);
          updateProgressCircle();
        } else {
          clearInterval(timer);
          running = false;
          startBtn.classList.remove('d-none');
          pauseBtn.classList.add('d-none');
          
          if (!isBreakMode) {
            const minutesStudied = Math.round(totalSeconds / 60);
            if(minutesStudied > 0) {
                saveStudyTime(minutesStudied);
                saveSessionToMongoDB(minutesStudied);
            }
          }
          alert(isBreakMode ? "Break Over!" : "Focus Session Complete!");
        }
      }, 1000);
    }

    function pauseTimer() {
      clearInterval(timer);
      running = false;
      startBtn.classList.remove('d-none');
      pauseBtn.classList.add('d-none');
    }

    function resetTimer() {
      pauseTimer();
      if(isBreakMode) {
          timeLeft = 5 * 60;
          display.value = "05:00";
      } else {
          timeLeft = 25 * 60;
          display.value = "25:00";
      }
      duration = timeLeft;
      totalSeconds = 0;
      updateProgressCircle();
    }

    // Event listeners
    startBtn.addEventListener("click", startTimer);
    pauseBtn.addEventListener("click", pauseTimer);
    resetBtn.addEventListener("click", resetTimer);
    focusTab.addEventListener("click", switchToFocusMode);
    breakTab.addEventListener("click", switchToBreakMode);

    display.addEventListener('change', () => {
        if(!running) {
            const secs = parseTimeInput(display.value);
            if(secs > 0) {
                timeLeft = secs;
                duration = secs;
                display.value = formatMMSS(secs);
            }
        }
    });

    // ===== SEND TO MONGODB =====
    async function saveSessionToMongoDB(durationMinutes) {
      try {
        await fetch('/timer/api/study/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ duration: durationMinutes, mode: "custom", subject: "general" })
        });
      } catch (err) {
        console.error("MongoDB Error:", err);
      }
    }

    // ===== LOCAL STATS LOGIC =====
    function saveStudyTime(minutes) {
      const today = new Date().toLocaleDateString();
      let data = JSON.parse(localStorage.getItem("studyData")) || {};
      data[today] = (data[today] || 0) + minutes;
      localStorage.setItem("studyData", JSON.stringify(data));
      updateStats();
    }

    function updateStats() {
      const data = JSON.parse(localStorage.getItem("studyData")) || {};
      const today = new Date().toLocaleDateString();
      const dailyMinutes = data[today] || 0;
      document.getElementById("daily-time").textContent = dailyMinutes;

      // Calculate streak
      let streak = 0;
      const sortedDays = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));
      let currentDate = new Date();
      for (let i = sortedDays.length - 1; i >= 0; i--) {
        const day = new Date(sortedDays[i]);
        if (data[sortedDays[i]] >= 1 && day.toDateString() === currentDate.toDateString()) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
            // Check if it's just yesterday missing or if we are checking today
            if(day.toDateString() !== currentDate.toDateString()) break;
        }
      }
      document.getElementById("streak").textContent = streak;
      updateLeaderboard();
    }

    function updateLeaderboard() {
      const data = JSON.parse(localStorage.getItem("studyData")) || {};
      const leaderboard = Object.entries(data)
        .map(([date, minutes]) => ({ date, minutes }))
        .sort((a, b) => b.minutes - a.minutes)
        .slice(0, 5);
      
      const container = document.getElementById("leaderboard-container");
      
      if (leaderboard.length === 0) {
        container.innerHTML = '<div class="text-center text-muted small p-3">No sessions yet.</div>';
      } else {
        container.innerHTML = leaderboard.map((entry, index) => {
          const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìÖ';
          return `
            <div class="leaderboard-item">
               <span class="fs-4">${medal}</span>
               <div>
                 <div class="fw-bold text-dark" style="font-size: 0.9rem;">${entry.date}</div>
                 <div class="text-muted" style="font-size: 0.8rem;">${entry.minutes} mins</div>
               </div>
            </div>
          `;
        }).join("");
      }
    }

    // Initialize
    updateStats();
  </script>
{% endblock %}
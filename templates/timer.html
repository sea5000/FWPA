{% extends "base.html" %}

{% block title %}Focus Timer | BookMe{% endblock %}

{% block head %}
    <!-- TailwindCSS for timer-specific styling -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    
    <script id="tailwind-config">
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "bookme-blue": "#8ecae6",
              "bookme-deep-blue": "#023047",
              "bookme-beige": "#fdf6e9",
              "bookme-beige-dark": "#f5e6d3",
              "bookme-yellow": "#ffb703",
              "bookme-soft-yellow": "#ffeaae",
              "bookme-charcoal": "#333333"
            },
            fontFamily: {
              "sans": ["'Plus Jakarta Sans'", "sans-serif"]
            }
          },
        },
      }
    </script>
    <style type="text/tailwindcss">
      :root {
        --soft-blue: #8ecae6;
        --soft-white: rgba(255, 255, 255, 0.7);
        --baby-yellow: #ffeaae;
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 1, "wght" 300, "GRAD" 0, "opsz" 24
      }
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        min-height: 100vh;
      }
      .soft-bg {
        background: radial-gradient(circle at top left, #fdf6e9, #f5e6d3);
      }
      .theme-beige {
        background: radial-gradient(circle at top left, #fdf6e9, #f5e6d3);
      }
      .theme-blue {
        background: linear-gradient(135deg, #e0f4ff 0%, #b3e0ff 100%);
      }
      .theme-yellow {
        background: linear-gradient(135deg, #fff9e6 0%, #ffe9b3 100%);
      }
      .theme-white {
        background: #ffffff;
      }
      .theme-grey {
        background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
      }
      .theme-black {
        background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
      }
      .theme-black .text-bookme-charcoal,
      .theme-black .text-bookme-deep-blue {
        color: #ffffff !important;
      }
      .theme-black .glass-panel {
        background: rgba(50, 50, 50, 0.7);
      }
      .theme-black input::placeholder {
        color: rgba(255, 255, 255, 0.5) !important;
      }
      .glass-panel {
        background: var(--soft-white);
        backdrop-filter: blur(16px);
        border-left: 1px solid var(--soft-blue);
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: var(--soft-blue);
        border-radius: 10px;
      }
    </style>
{% endblock %}

{% block body_attrs %}class="antialiased text-bookme-charcoal soft-bg" style="overflow-x: hidden;"{% endblock %}

{% block content %}
  <div style="height: 1px; background: linear-gradient(to right, transparent, rgba(142, 202, 230, 0.3) 20%, rgba(142, 202, 230, 0.3) 80%, transparent);"></div>

  <div class="relative" style="height: calc(100vh - 80px);">
    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-y-auto">
      <!-- Header Tabs -->
      <header class="flex justify-center pt-8 z-10">
        <div class="flex gap-12">
          <button id="focus-tab" class="text-[12px] font-bold tracking-[0.25em] text-bookme-deep-blue border-b-2 border-bookme-yellow pb-2">FOCUS</button>
          <button id="break-tab" class="text-[12px] font-bold tracking-[0.25em] text-bookme-blue/60 pb-2 hover:text-bookme-blue transition-colors">BREAK</button>
        </div>
      </header>

      <div class="flex flex-1 flex-col lg:flex-row">
        <!-- Timer Section -->
        <section class="flex-1 flex flex-col items-center justify-center p-12">
          <div class="relative flex items-center justify-center">
            <!-- SVG Circle Progress -->
            <svg class="w-[380px] h-[380px] -rotate-90">
              <circle class="text-white/80" cx="50%" cy="50%" fill="transparent" r="48%" stroke="currentColor" stroke-width="6"></circle>
              <circle id="progress-circle" class="text-bookme-soft-yellow transition-all duration-300" cx="50%" cy="50%" fill="transparent" r="48%" stroke="currentColor" stroke-dasharray="1150" stroke-dashoffset="1150" stroke-linecap="round" stroke-width="8"></circle>
            </svg>
            
            <!-- Timer Display -->
            <div class="absolute inset-0 flex flex-col items-center justify-center pt-4">
              <input type="text" id="timer-input" class="bg-transparent border-none text-center text-bookme-deep-blue text-[100px] font-bold leading-none tracking-tight focus:ring-0 focus:outline-none w-full max-w-[320px]" placeholder="25:00" />
              
              <div class="mt-8 flex flex-col items-center w-full max-w-[280px]">
                <input id="focus-input" class="bg-transparent border-none text-center text-bookme-deep-blue placeholder:text-bookme-deep-blue/40 focus:ring-0 text-xl font-medium w-full" placeholder="I will focus on..." type="text" />
                <div class="w-12 h-[2px] bg-bookme-blue/30 mt-2"></div>
              </div>
            </div>
          </div>

          <!-- Control Buttons -->
          <div class="mt-12 flex gap-4">
            <button id="start" class="size-20 rounded-full bg-bookme-soft-yellow flex items-center justify-center hover:bg-bookme-yellow transition-all border border-white shadow-lg">
              <span class="material-symbols-outlined text-bookme-deep-blue text-4xl">play_arrow</span>
            </button>
            <button id="pause" class="size-20 rounded-full bg-bookme-blue/20 flex items-center justify-center hover:bg-bookme-blue/40 transition-all border border-white shadow-lg hidden">
              <span class="material-symbols-outlined text-bookme-deep-blue text-4xl">pause</span>
            </button>
            <button id="reset" class="size-16 rounded-full bg-white/60 flex items-center justify-center hover:bg-white transition-all border border-bookme-blue/20 shadow">
              <span class="material-symbols-outlined text-bookme-blue text-2xl">refresh</span>
            </button>
          </div>

          <!-- Theme Selector -->
          <div class="mt-8 flex justify-center">
            <div class="dropdown">
              <button class="flex items-center gap-2 px-4 py-2 rounded-full bg-white/60 border border-bookme-blue/20 hover:bg-white transition-all shadow-sm" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="material-symbols-outlined text-bookme-blue text-xl">palette</span>
                <span class="text-sm font-medium text-bookme-charcoal">Theme</span>
              </button>
              <ul class="dropdown-menu">
                <li><h6 class="dropdown-header">Background Theme</h6></li>
                <li><a class="dropdown-item" href="#" onclick="changeTheme('beige'); return false;">‚òÅÔ∏è Light Beige</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeTheme('blue'); return false;">üíô Light Blue</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeTheme('yellow'); return false;">‚òÄÔ∏è Light Yellow</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeTheme('white'); return false;">‚ö™ White</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeTheme('grey'); return false;">üå´Ô∏è Grey</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeTheme('black'); return false;">üåô Black</a></li>
              </ul>
            </div>
          </div>
        </section>

        <!-- Sidebar Panel -->
        <aside class="w-full lg:w-[420px] glass-panel flex flex-col p-8 z-10 max-h-[calc(100vh-8rem)] lg:max-h-full">
          <!-- Stats Section -->
          <div class="mb-6">
            <h3 class="text-lg font-bold tracking-tight text-bookme-deep-blue mb-4">üìä Today's Progress</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-white/60 border border-bookme-blue/10">
                <p class="text-[11px] text-bookme-blue uppercase font-bold tracking-wider">Study Time</p>
                <p class="text-2xl font-bold text-bookme-deep-blue"><span id="daily-time">0</span> <span class="text-sm">min</span></p>
              </div>
              <div class="p-4 rounded-2xl bg-white/60 border border-bookme-blue/10">
                <p class="text-[11px] text-bookme-blue uppercase font-bold tracking-wider">Streak</p>
                <p class="text-2xl font-bold text-bookme-deep-blue"><span id="streak">0</span> <span class="text-sm">days</span></p>
              </div>
            </div>
          </div>

          <!-- Leaderboard Section -->
          <div class="flex-1 overflow-y-auto custom-scrollbar pr-2">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold tracking-tight text-bookme-deep-blue">üèÜ Top Sessions</h3>
            </div>
            <div id="leaderboard-container" class="flex flex-col gap-3"></div>
          </div>

          <!-- Quote Footer -->
          <div class="mt-6 pt-6 border-t border-bookme-blue/20">
            <p class="text-bookme-deep-blue/50 text-sm italic font-light tracking-wide text-center">
              Now is the time to move toward my goals
            </p>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Mobile Footer -->
  <footer class="d-md-none fixed-bottom bg-white border-top">
    <nav class="nav justify-content-around py-2">
      <a class="nav-link text-muted" href="{{ url_for('home.index') }}">
        <span class="material-symbols-outlined">home</span>
        <small class="d-block">Home</small>
      </a>
      <a class="nav-link text-muted" href="{{ url_for('study.index') }}">
        <span class="material-symbols-outlined">school</span>
        <small class="d-block">Study</small>
      </a>
      <a class="nav-link text-muted" href="{{ url_for('community.index') }}">
        <span class="material-symbols-outlined">groups</span>
        <small class="d-block">Community</small>
      </a>
    </nav>
  </footer>

  <!-- Bottom Home Indicator -->
  <div class="fixed bottom-1.5 left-1/2 -translate-x-1/2 w-32 h-1 bg-bookme-deep-blue/10 rounded-full z-30"></div>
{% endblock %}

{% block scripts %}
  <script>
    // THEME SWITCHING
    function changeTheme(theme) {
      const body = document.body;
      const themeClasses = ['theme-beige', 'theme-blue', 'theme-yellow', 'theme-white', 'theme-grey', 'theme-black'];
      
      // Remove all theme classes
      themeClasses.forEach(cls => body.classList.remove(cls));
      
      // Add selected theme
      body.classList.add(`theme-${theme}`);
      
      // Save to localStorage
      localStorage.setItem('timerTheme', theme);
    }

    // Load saved theme on page load
    function loadSavedTheme() {
      const savedTheme = localStorage.getItem('timerTheme');
      if (savedTheme) {
        changeTheme(savedTheme);
      }
    }

    // Initialize theme on page load
    loadSavedTheme();

    // TIMER LOGIC
    let timer = null;
    let running = false;
    let timeLeft = 0;
    let duration = 0;
    let totalSeconds = 0;
    let isBreakMode = false;

    const display = document.getElementById("timer-input");
    const progressCircle = document.getElementById("progress-circle");
    const startBtn = document.getElementById("start");
    const pauseBtn = document.getElementById("pause");
    const resetBtn = document.getElementById("reset");
    const focusTab = document.getElementById("focus-tab");
    const breakTab = document.getElementById("break-tab");

    display.style.fontVariantNumeric = 'tabular-nums';

    // Circle circumference (2 * PI * radius), radius = 48% of 380/2 = 91.2
    const circleCircumference = 1150;

    function formatMMSS(seconds) {
      const mm = Math.floor(seconds / 60).toString().padStart(2, '0');
      const ss = (seconds % 60).toString().padStart(2, '0');
      return `${mm}:${ss}`;
    }

    function updateProgressCircle() {
      if (duration > 0) {
        const progress = (1 - timeLeft / duration);
        const offset = circleCircumference - (progress * circleCircumference);
        progressCircle.style.strokeDashoffset = offset;
      } else {
        progressCircle.style.strokeDashoffset = circleCircumference;
      }
    }

    function parseTimeInput(value) {
      if (!value || value.trim() === '') return 0;
      const trimmed = value.trim();
      if (trimmed.includes(':')) {
        const [mm, ss] = trimmed.split(':').map(n => parseInt(n) || 0);
        return Math.max(0, mm * 60 + ss);
      }
      const minutes = parseFloat(trimmed);
      return isNaN(minutes) ? 0 : Math.max(0, Math.round(minutes * 60));
    }

    function switchToFocusMode() {
      isBreakMode = false;
      focusTab.className = "text-[12px] font-bold tracking-[0.25em] text-bookme-deep-blue border-b-2 border-bookme-yellow pb-2";
      breakTab.className = "text-[12px] font-bold tracking-[0.25em] text-bookme-blue/60 pb-2 hover:text-bookme-blue transition-colors";
      progressCircle.className = "text-bookme-soft-yellow transition-all duration-300";
      if (!running && !display.value) {
        display.placeholder = "25:00";
      }
    }

    function switchToBreakMode() {
      isBreakMode = true;
      breakTab.className = "text-[12px] font-bold tracking-[0.25em] text-bookme-deep-blue border-b-2 border-bookme-yellow pb-2";
      focusTab.className = "text-[12px] font-bold tracking-[0.25em] text-bookme-blue/60 pb-2 hover:text-bookme-blue transition-colors";
      progressCircle.className = "text-bookme-blue transition-all duration-300";
      if (!running && !display.value) {
        display.placeholder = "05:00";
      }
    }

    function startTimer() {
      if (running) return;
      const secs = parseTimeInput(display.value);
      if (secs <= 0) {
        const defaultTime = isBreakMode ? 5 * 60 : 25 * 60;
        duration = defaultTime;
        timeLeft = defaultTime;
      } else {
        duration = secs;
        timeLeft = secs;
      }
      
      totalSeconds = 0;
      running = true;
      display.readOnly = true;
      
      // Toggle button visibility
      startBtn.classList.add('hidden');
      pauseBtn.classList.remove('hidden');
      
      updateProgressCircle();
      timer = setInterval(() => {
        if (timeLeft > 0) {
          timeLeft--;
          totalSeconds++;
          display.value = formatMMSS(timeLeft);
          updateProgressCircle();
        } else {
          clearInterval(timer);
          running = false;
          startBtn.classList.remove('hidden');
          pauseBtn.classList.add('hidden');
          
          if (!isBreakMode) {
            const minutesStudied = Math.round(totalSeconds / 60);
            saveStudyTime(minutesStudied);
            saveSessionToMongoDB(minutesStudied);
          }
          
          display.readOnly = false;
          showCompletionNotification();
        }
      }, 1000);
    }

    function pauseTimer() {
      clearInterval(timer);
      running = false;
      startBtn.classList.remove('hidden');
      pauseBtn.classList.add('hidden');
    }

    function resetTimer() {
      clearInterval(timer);
      running = false;
      timeLeft = 0;
      duration = 0;
      totalSeconds = 0;
      display.value = '';
      display.readOnly = false;
      progressCircle.style.strokeDashoffset = circleCircumference;
      startBtn.classList.remove('hidden');
      pauseBtn.classList.add('hidden');
    }

    function showCompletionNotification() {
      const message = isBreakMode ? 'Break complete! Ready to focus again?' : 'Session complete! Great work!';
      
      // Create custom notification
      const notification = document.createElement('div');
      notification.className = 'fixed top-8 left-1/2 -translate-x-1/2 bg-bookme-soft-yellow border-2 border-bookme-yellow rounded-2xl px-6 py-4 shadow-2xl z-50 animate-bounce';
      notification.innerHTML = `
        <p class="text-bookme-deep-blue font-bold text-center">${message}</p>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Event listeners
    startBtn.addEventListener("click", startTimer);
    pauseBtn.addEventListener("click", pauseTimer);
    resetBtn.addEventListener("click", resetTimer);
    focusTab.addEventListener("click", switchToFocusMode);
    breakTab.addEventListener("click", switchToBreakMode);

    display.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        startTimer();
      }
    });

    // ===== SEND TO MONGODB =====
    async function saveSessionToMongoDB(durationMinutes) {
      try {
        const response = await fetch('/timer/api/study/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ duration: durationMinutes, mode: "custom", subject: "general" })
        });
        const data = await response.json();
        console.log("MongoDB Save:", data.message);
      } catch (err) {
        console.error("MongoDB Error:", err);
      }
    }

    // ===== LOCAL STATS LOGIC =====
    function saveStudyTime(minutes) {
      const today = new Date().toLocaleDateString();
      let data = JSON.parse(localStorage.getItem("studyData")) || {};
      data[today] = (data[today] || 0) + minutes;
      localStorage.setItem("studyData", JSON.stringify(data));
      updateStats();
    }

    function updateStats() {
      const data = JSON.parse(localStorage.getItem("studyData")) || {};
      const today = new Date().toLocaleDateString();
      const dailyMinutes = data[today] || 0;
      document.getElementById("daily-time").textContent = dailyMinutes;

      // Calculate streak
      let streak = 0;
      const sortedDays = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));
      let currentDate = new Date();
      for (let i = sortedDays.length - 1; i >= 0; i--) {
        const day = new Date(sortedDays[i]);
        if (data[sortedDays[i]] >= 40 && day.toDateString() === currentDate.toDateString()) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
          break;
        }
      }
      document.getElementById("streak").textContent = streak;
      localStorage.setItem("streak", streak);
      updateLeaderboard();
    }

    function updateLeaderboard() {
      const data = JSON.parse(localStorage.getItem("studyData")) || {};
      const leaderboard = Object.entries(data)
        .map(([date, minutes]) => ({ date, minutes }))
        .sort((a, b) => b.minutes - a.minutes)
        .slice(0, 5);
      
      const container = document.getElementById("leaderboard-container");
      
      if (leaderboard.length === 0) {
        container.innerHTML = `
          <div class="p-4 rounded-2xl bg-white/40 border border-bookme-blue/10 text-center">
            <p class="text-sm text-bookme-blue/60">No sessions yet. Start your first timer!</p>
          </div>
        `;
      } else {
        container.innerHTML = leaderboard.map((entry, index) => {
          const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìÖ';
          return `
            <div class="p-4 rounded-2xl bg-white/60 border border-bookme-blue/10 hover:bg-white transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <span class="text-2xl">${medal}</span>
                  <div>
                    <p class="text-sm font-semibold text-bookme-charcoal">${entry.date}</p>
                    <p class="text-[11px] text-bookme-blue">${entry.minutes} minutes studied</p>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("");
      }
    }

    // Initialize
    updateStats();
  </script>
{% endblock %}